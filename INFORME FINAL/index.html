<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortalecimiento del Ecosistema Cultural y Comunitario - Convenio 1022-2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        lance: ['Impact', 'sans-serif'],
                        montserrat: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        palette: {
                            dark: '#1A1A3A',
                            purple: '#886FFF',
                            deepPurple: '#5D3FD3',
                            blue: '#0066FF',
                            lightblue: '#5BC6FB',
                            yellow: '#F3C746',
                            pink: '#E940B4',
                            white: '#FFFFFF',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- Leaflet (Mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" crossorigin=""/>

    <!-- Fuentes e Iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;900&family=Merriweather+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @font-face {
            font-family: 'LanceAPLP';
            src: url('../assets/fonts/Lance-RegularAPLP.woff2') format('woff2');
        }
        body { font-family: 'Montserrat', sans-serif; }
        h1, h2, h3, h4, h5, h6 { font-family: 'LanceAPLP', 'Impact', sans-serif; letter-spacing: 0.05em; }
        
        /* Glassmorphism Global */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .glass-dark {
            background: rgba(26, 26, 58, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        /* --- ESTILOS DEL MAPA INTEGRADO --- */
        #map-wrapper {
            position: relative;
            height: 700px;
            width: 100%;
            border-radius: 1.5rem;
            overflow: hidden;
            z-index: 1;
        }
        #map { width: 100%; height: 100%; z-index: 1; }
        
        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            max-width: 320px;
            max-height: 650px;
            overflow-y: auto;
        }

        /* Clusters Personalizados */
        .marker-cluster div {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #886FFF;
            color: #1A1A3A; font-weight: bold; font-size: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* Colores por Red */
        .marker-cluster-hiphop div { border-color: #E940B4; color: #E940B4; } 
        .marker-cluster-emergentes div { border-color: #0066FF; color: #0066FF; } 
        .marker-cluster-juvenil div { border-color: #F3C746; color: #F3C746; } 
        .marker-cluster-mujeres div { border-color: #886FFF; color: #886FFF; }
        .marker-cluster-circulacion div { border-color: #5BC6FB; color: #5BC6FB; }

        /* Animación suave */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }
        .floating { animation: float 5s ease-in-out infinite; }

        /* --- ESTILOS GALERÍA --- */
        .carousel-slide {
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 0.8s ease-in-out, transform 8s ease;
            background-size: cover;
            background-position: center;
            transform: scale(1);
        }
        .carousel-slide.active { opacity: 1; transform: scale(1.05); }
        
        .carousel-caption-gradient {
            background: linear-gradient(to top, rgba(26, 26, 58, 0.95) 0%, rgba(26, 26, 58, 0.7) 50%, transparent 100%);
        }

        /* Scrollbar para mosaico */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
    </style>
</head>
<body class="bg-gradient-to-br from-palette-yellow via-white to-palette-lightblue min-h-screen text-palette-dark antialiased">

    <!-- 1. HEADER -->
    <header class="bg-palette-dark text-white pt-8 pb-32 px-6 rounded-b-[4rem] shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-10"></div>
        <div class="absolute -right-20 -top-20 w-96 h-96 bg-palette-purple opacity-30 rounded-full blur-[100px]"></div>

        <div class="relative z-10 max-w-6xl mx-auto text-center">
            
            <!-- Logos -->
            <div class="flex justify-between items-center mb-12 px-4">
                <a href="https://www.mincultura.gov.co/areas/artes/artes-para-la-paz" target="_blank" class="hover:opacity-80 transition-opacity">
                    <img src="../assets/img/aplp_morado.png" alt="Artes para la Paz" class="h-10 md:h-12 object-contain drop-shadow-lg">
                </a>
                <a href="https://www.mincultura.gov.co" target="_blank" class="hover:opacity-80 transition-opacity">
                    <img src="../assets/img/blanco_culturas.png" alt="Colombia Potencia de la Vida" class="h-16 md:h-20 object-contain drop-shadow-lg">
                </a>
            </div>

            <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-6">
                <span class="bg-palette-pink px-4 py-1 rounded-full text-xl font-bold uppercase tracking-widest shadow-lg transform -rotate-2">
                    Balance Mayo '25 - Ene '26
                </span>
                <i class="fas fa-arrow-right text-palette-yellow hidden md:block"></i>
                <span class="bg-palette-yellow text-palette-dark px-4 py-1 rounded-full text-xl font-bold uppercase tracking-widest shadow-lg transform rotate-1">
                    Proyección Feb '26 - Jun '26
                </span>
            </div>

            <h1 class="text-2xl sm:text-3xl md:text-6xl font-normal mb-6 leading-none tracking-tight uppercase break-words">
                Fortalecimiento del<br>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-palette-pink to-palette-yellow">
                    Ecosistema Cultural y Comunitario
                </span>
                <span class="block mt-3 text-sm sm:text-base md:text-2xl font-bold text-gray-200 tracking-widest">Convenio 1022-2025</span>
                <span class="block mt-2 font-montserrat text-[10px] sm:text-xs md:text-sm font-semibold text-gray-200 tracking-wide normal-case">Ministerio de las Culturas, las Artes y los Saberes - Fondo Mixto de Promoción de la Cultura y las Artes de Nariño</span>
            </h1>
            
            <p class="text-lg font-light text-gray-300 max-w-4xl mx-auto">
                <span id="total-processes-count">150</span> procesos fortalecidos. Un ecosistema de <strong class="text-palette-lightblue">trabajo colectivo y organización social</strong> para las artes, las culturas y los saberes de base comunitaria.
            </p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 -mt-24 relative z-20 pb-24 space-y-16">

        <!-- 2. MAPA INTERACTIVO -->
        <section class="glass-card bg-white rounded-[2rem] p-4 shadow-xl ring-4 ring-white/50 relative">
            <div class="absolute -top-6 left-8 bg-palette-blue text-white px-6 py-2 rounded-lg shadow-lg z-20 font-bold flex items-center gap-2">
                <img src="../assets/img/Iconos_Amarillo/CCDP_Icono_Montanas_Sin_Marco.png" class="h-6 w-6 object-contain brightness-0 invert"> Territorio e Inversión
            </div>
            
            <!-- ESTADÍSTICAS Y BOTONES (Arriba del Mapa) -->
            <div class="mt-6 mb-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <!-- DASHBOARD BUTTON -->
                <button onclick="toggleDashboard()" class="w-full md:w-auto bg-palette-dark text-white py-3 px-6 rounded-xl font-bold text-xs hover:bg-palette-purple transition-colors shadow-lg flex items-center justify-center gap-2 uppercase tracking-wider order-1 md:order-2">
                    <i class="fas fa-chart-pie"></i> Ver Estadísticas
                </button>

                <!-- STATS CARDS -->
                <div class="grid grid-cols-2 md:flex md:flex-row gap-3 w-full md:w-auto order-2 md:order-1 items-stretch">
                    <div class="bg-gray-50 border border-gray-200 p-2 px-3 rounded-xl text-center shadow-sm flex flex-col justify-center md:w-24">
                        <div class="text-lg md:text-xl font-black text-palette-dark leading-none" id="total-ben-count">0</div>
                        <div class="text-[8px] md:text-[9px] uppercase opacity-60 font-bold mt-1 leading-tight">Beneficiarios</div>
                    </div>
                    <div id="muni-card" onclick="toggleImpactList('muni')" class="bg-gray-50 border border-gray-200 p-2 px-3 rounded-xl text-center shadow-sm flex flex-col justify-center cursor-pointer select-none md:w-auto min-w-[100px] hover:bg-gray-100 transition-colors">
                        <div class="flex items-center justify-center gap-3">
                            <div class="text-center">
                                <div class="text-lg md:text-xl font-black text-palette-dark leading-none" id="total-dept-display">30</div>
                                <div class="text-[7px] md:text-[8px] uppercase opacity-60 font-bold mt-1 leading-tight">Dptos.</div>
                            </div>
                            <div class="text-palette-dark opacity-40">|</div>
                            <div class="text-center">
                                <div class="text-lg md:text-xl font-black text-palette-dark leading-none" id="total-muni-count">112</div>
                                <div class="text-[7px] md:text-[8px] uppercase opacity-60 font-bold mt-1 leading-tight">Mpios.</div>
                            </div>
                        </div>
                        <div class="text-[8px] md:text-[9px] uppercase opacity-60 font-bold mt-1 leading-tight">Territorios alcanzados</div>
                    </div>
                    <div class="bg-gradient-to-br from-palette-blue to-palette-purple text-white p-2 px-3 rounded-xl text-center shadow-sm flex flex-col justify-center md:w-28">
                        <div class="text-lg md:text-xl font-black leading-none">105</div>
                        <div class="text-[8px] md:text-[9px] uppercase opacity-80 font-bold mt-1 leading-tight">Org. de base fortalecidas</div>
                    </div>
                    <div id="dept-card" class="bg-gray-50 border border-gray-200 p-2 px-3 rounded-xl text-center shadow-sm flex flex-col justify-center md:w-28">
                        <div class="text-lg md:text-xl font-black text-palette-dark leading-none" id="total-dept-count">0</div>
                        <div class="text-[8px] md:text-[9px] uppercase opacity-60 font-bold mt-1 leading-tight">Beneficiarios directos</div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 p-2 px-3 rounded-xl text-center shadow-sm flex flex-col justify-center md:w-28">
                        <div class="text-lg md:text-xl font-black leading-none text-palette-dark" id="total-operational-count">0</div>
                        <div class="text-[8px] md:text-[9px] uppercase opacity-60 font-bold mt-1 leading-tight">Beneficiarios indirectos</div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 p-2 px-3 rounded-xl text-center shadow-sm flex flex-col justify-center md:w-28">
                        <div class="text-lg md:text-xl font-black leading-none text-palette-dark" id="total-operational-costs-count">0</div>
                        <div class="text-[8px] md:text-[9px] uppercase opacity-60 font-bold mt-1 leading-tight">Beneficiarios público</div>
                    </div>
                    <div class="bg-gradient-to-br from-palette-pink to-palette-purple text-white p-2 px-4 rounded-xl text-center shadow-sm flex flex-col justify-center md:flex-1 min-w-[140px]">
                        <div class="text-sm md:text-lg font-black leading-none w-full text-center tracking-tight" id="total-contribution-count">$0</div>
                        <div class="text-[8px] md:text-[9px] uppercase opacity-80 mt-1 leading-tight">Inversión total (COP)</div>
                    </div>
                </div>
            </div>

            <!-- LISTADOS (se despliegan al hacer clic en Territorios alcanzados) -->
            <div id="impact-lists" class="hidden mt-2 bg-gray-50 border border-gray-200 rounded-xl p-3 text-xs">
                <div class="flex items-start justify-between gap-2">
                    <div class="font-bold text-palette-dark">Listado de cobertura territorial</div>
                    <button type="button" onclick="closeImpactLists()" class="text-gray-500 hover:text-gray-700">Cerrar</button>
                </div>
                <div id="impact-muni-panel" class="hidden mt-3">
                    <!-- Departamentos -->
                    <div class="font-bold text-palette-dark mb-2">Departamentos (30)</div>
                    <div class="bg-white rounded-lg border border-gray-200 p-2 mb-4">
                        <div class="max-h-40 overflow-y-auto pr-1">
                            <ul id="impact-dept-list" class="space-y-1 columns-2 md:columns-3"></ul>
                        </div>
                    </div>
                    <!-- Municipios/Ciudades -->
                    <div class="font-bold text-palette-dark mb-2">Municipios y Ciudades (112)</div>
                    <div class="bg-white rounded-lg border border-gray-200 p-2">
                        <div class="max-h-60 overflow-y-auto pr-1">
                            <ul id="impact-combined-list" class="space-y-1"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="map-wrapper" class="relative group">
                
                <!-- BOTÓN HAMBURGUESA (Móvil) -->
                <button id="filter-toggle" class="md:hidden absolute top-4 left-4 z-[1001] bg-white text-palette-dark p-3 rounded-full shadow-lg hover:bg-gray-100 transition-colors">
                    <i class="fas fa-bars"></i>
                </button>

                <!-- BOTÓN PANTALLA COMPLETA -->
                <button onclick="toggleFullScreen()" class="absolute bottom-8 right-4 z-[1000] bg-white text-palette-dark p-2 rounded-lg shadow-lg hover:bg-gray-100 transition-colors text-xs font-bold hidden md:block" title="Pantalla completa">
                    <i class="fas fa-expand"></i>
                </button>

                <!-- PANEL DE FILTROS (Responsive) -->
                <div id="map-controls" class="map-controls glass-card p-4 rounded-xl m-2 hidden md:block absolute top-14 left-2 md:top-2 md:left-2 z-[1000] w-64 md:w-72 max-h-[60vh] overflow-y-auto transition-all duration-300">
                    <div class="flex justify-between items-center md:hidden mb-4">
                        <h3 class="font-bold text-palette-dark">Filtros</h3>
                        <button onclick="toggleFilters()" class="text-gray-500"><i class="fas fa-times"></i></button>
                    </div>

                    <h3 class="font-bold text-palette-dark mb-3 text-sm border-b border-gray-300 pb-2">Filtros de Red</h3>
                    <div id="filters-list" class="space-y-2 text-xs font-medium"></div>
                    
                    <h3 class="font-bold text-palette-dark mt-4 mb-3 text-sm border-b border-gray-300 pb-2">Actividad</h3>
                    <div class="space-y-1 text-xs">
                        <label class="flex items-center cursor-pointer hover:bg-palette-blue/10 p-1 rounded"><input type="checkbox" class="activity-check mr-2" value="formacion" checked> Formación</label>
                        <label class="flex items-center cursor-pointer hover:bg-palette-pink/10 p-1 rounded"><input type="checkbox" class="activity-check mr-2" value="circulacion" checked> Circulación</label>
                        <label class="flex items-center cursor-pointer hover:bg-palette-yellow/10 p-1 rounded"><input type="checkbox" class="activity-check mr-2" value="publico" checked> Eventos Públicos</label>
                    </div>
                </div>

                <!-- Buscador Flotante -->
                <div class="absolute top-4 right-4 left-16 md:left-auto z-[1000] md:w-64">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Buscar..." class="w-full pl-4 pr-10 py-2 rounded-full shadow-lg border-none focus:ring-2 focus:ring-palette-purple text-sm bg-white/90 backdrop-blur-sm">
                        <button id="search-clear" class="absolute right-8 top-2 text-gray-400 hover:text-palette-pink hidden"><i class="fas fa-times"></i></button>
                        <button class="absolute right-3 top-2 text-palette-purple"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="search-suggestions" class="hidden bg-white mt-1 rounded-lg shadow-xl max-h-40 overflow-y-auto text-sm absolute w-full z-50"></div>
                </div>

                <div id="map"></div>
            </div>
            <div class="text-center mt-2">
                <p class="text-xs text-palette-dark opacity-60"><i class="fas fa-info-circle"></i> Haz clic en los clusters para desagregar. Los montos reflejan la inversión en fortalecimiento.</p>
            </div>
        </section>

        <!-- 3. GALERÍA FOTOGRÁFICA -->
        <section id="photo-gallery-section" class="relative w-full h-[500px] md:h-[650px] rounded-[2rem] shadow-2xl ring-4 ring-palette-purple/20 bg-palette-dark overflow-hidden group transition-all duration-500">
            
            <!-- Contenedor Principal (Carrusel / Mosaico) -->
            <div id="gallery-container" class="w-full h-full relative">
                <!-- Se llena dinámicamente con JS -->
            </div>

            <!-- Controles de Navegación (Solo visibles en modo Carrusel) -->
            <div id="gallery-nav-controls" class="pointer-events-none absolute inset-0 flex items-center justify-between px-4 z-20">
                <button onclick="moveSlide(-1)" class="pointer-events-auto bg-white/10 hover:bg-white/30 text-white p-4 rounded-full backdrop-blur-md transition-all opacity-0 group-hover:opacity-100 hover:scale-110 transform -translate-x-2 group-hover:translate-x-0">
                    <i class="fas fa-chevron-left text-xl"></i>
                </button>
                <button onclick="moveSlide(1)" class="pointer-events-auto bg-white/10 hover:bg-white/30 text-white p-4 rounded-full backdrop-blur-md transition-all opacity-0 group-hover:opacity-100 hover:scale-110 transform translate-x-2 group-hover:translate-x-0">
                    <i class="fas fa-chevron-right text-xl"></i>
                </button>
            </div>

            <!-- Barra de Herramientas Superior -->
            <div class="absolute top-6 right-6 flex gap-3 z-30">
                <button onclick="toggleCarouselPlay()" id="btn-play-pause" class="bg-black/40 hover:bg-palette-pink text-white w-10 h-10 rounded-full backdrop-blur-md transition-colors flex items-center justify-center shadow-lg" title="Pausar/Reproducir">
                    <i class="fas fa-pause"></i>
                </button>
                <button onclick="toggleCarouselFullscreen()" class="bg-black/40 hover:bg-palette-blue text-white w-10 h-10 rounded-full backdrop-blur-md transition-colors flex items-center justify-center shadow-lg" title="Pantalla Completa">
                    <i class="fas fa-expand"></i>
                </button>
            </div>

            <!-- Indicador de carga -->
            <div id="gallery-loader" class="absolute inset-0 flex items-center justify-center bg-palette-dark z-0">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-palette-pink"></div>
            </div>
        </section>

        <!-- 4. LO QUE PROPONEMOS (COLAPSABLE) -->
        <section>
            <div class="flex items-center gap-4 mb-8 cursor-pointer" onclick="toggleProponemos()">
                <div class="h-px bg-palette-dark flex-1 opacity-20"></div>
                <h2 class="text-3xl font-black text-palette-dark uppercase text-center flex items-center gap-3">
                    Lo que proponemos entonces...
                    <i id="proponemos-icon" class="fas fa-chevron-down text-xl transition-transform duration-300"></i>
                </h2>
                <div class="h-px bg-palette-dark flex-1 opacity-20"></div>
            </div>

            <div id="proponemos-content" class="grid md:grid-cols-2 gap-8 transition-all duration-500 overflow-hidden">
                <!-- PREGUNTA 1: LA PERSPECTIVA -->
                <div class="glass-dark rounded-[2.5rem] p-8 md:p-10 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 bg-palette-pink w-32 h-32 rounded-bl-[100%] opacity-20 transition-all group-hover:scale-110"></div>
                    <div class="relative z-10">
                        <h3 class="text-2xl font-bold mb-6 flex items-start gap-3">
                            <span class="text-palette-pink text-4xl">01.</span>
                            <div class="mt-1">
                                <span class="block text-xs uppercase tracking-widest opacity-70 mb-1">La Perspectiva</span>
                                ¿Qué organización queremos ver?
                            </div>
                        </h3>
                        <ul class="space-y-6">
                            <li class="flex gap-4 items-center">
                                <div class="bg-palette-pink/20 p-2 rounded-xl h-fit shrink-0">
                                    <img src="../assets/img/Iconos_Amarillo/CCDP_Icono_Megafono_Sin_Marco.png" class="w-24 h-24 object-contain">
                                </div>
                                <div>
                                    <h4 class="font-bold text-lg">Sujeto Político Activo</h4>
                                    <p class="text-sm text-gray-300 font-light">Organizaciones que no solo ejecutan, sino que <span class="text-white font-medium">intervienen y afectan</span> sus contextos territoriales.</p>
                                </div>
                            </li>
                            <li class="flex gap-4 items-center">
                                <div class="bg-palette-yellow/20 p-2 rounded-xl h-fit shrink-0">
                                    <img src="../assets/img/Iconos_Amarillo/CCDP_Icono_Resistencia_Sin_Marco.png" class="w-24 h-24 object-contain">
                                </div>
                                <div>
                                    <h4 class="font-bold text-lg">Autónoma & Sostenible</h4>
                                    <p class="text-sm text-gray-300 font-light">Menos dependencia gubernamental ("papelitos"), más capacidad de cooperación internacional.</p>
                                </div>
                            </li>
                            <li class="flex gap-4 items-center">
                                <div class="bg-palette-lightblue/20 p-2 rounded-xl h-fit shrink-0">
                                    <img src="../assets/img/Iconos_Amarillo/CCDP_Icono_Corazon_Sin_Marco.png" class="w-24 h-24 object-contain">
                                </div>
                                <div>
                                    <h4 class="font-bold text-lg">Cuidadora hacia adentro y hacia afuera</h4>
                                    <p class="text-sm text-gray-300 font-light">Que prioriza la salud mental, reconoce los límites y aplica tecnologías del cuidado.</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- PREGUNTA 2: LA RUTA -->
                <div class="bg-white rounded-[2.5rem] p-8 md:p-10 border-2 border-palette-dark relative shadow-2xl">
                    <h3 class="text-2xl font-bold mb-6 text-palette-dark flex items-start gap-3">
                        <span class="text-palette-purple text-4xl">02.</span>
                        <div class="mt-1">
                            <span class="block text-xs uppercase tracking-widest text-gray-500 mb-1">La Ruta</span>
                            ¿Qué necesitan para lograrlo?
                        </div>
                    </h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="bg-gray-50 p-4 rounded-xl border-l-4 border-palette-purple hover:bg-purple-50 transition-colors">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-palette-dark">Educación Financiera Real</h4>
                                <img src="../assets/img/Iconos_Amarillo/CCDP_Icono_Olla_Sin_Marco.png" class="w-20 h-20 object-contain opacity-80 shrink-0">
                            </div>
                            <p class="text-xs text-gray-600">Herramientas para manejar balances, impuestos y gestión de recursos privados/mixtos.</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl border-l-4 border-palette-blue hover:bg-blue-50 transition-colors">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-palette-dark">Sistematización (SOPs)</h4>
                                <img src="../assets/img/Iconos_Amarillo/CCDP_Icono_Libro_Sin_Marco.png" class="w-20 h-20 object-contain opacity-80 shrink-0">
                            </div>
                            <p class="text-xs text-gray-600">Dejar de reinventar la rueda. Crear manuales de procesos administrativos y metodológicos.</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl border-l-4 border-palette-pink hover:bg-pink-50 transition-colors">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-palette-dark">Investigación de su Hacer</h4>
                                <img src="../assets/img/Iconos_Amarillo/CCDP_Icono_Ojo_Sin_Marco.png" class="w-20 h-20 object-contain opacity-80 shrink-0">
                            </div>
                            <p class="text-xs text-gray-600">Tiempo y recursos para preguntarse por su historia y renovar sus apuestas pedagógicas.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <script>
        function toggleProponemos() {
            const content = document.getElementById('proponemos-content');
            const icon = document.getElementById('proponemos-icon');
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                content.style.opacity = '1';
                icon.style.transform = 'rotate(180deg)';
            }
        }
        // Inicializar colapsado
        document.addEventListener('DOMContentLoaded', function() {
            const content = document.getElementById('proponemos-content');
            if (content) {
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
                document.getElementById('proponemos-icon').style.transform = 'rotate(0deg)';
            }
        });
        </script>

    </main>

    <!-- FICHA PLATAFORMA PUENTE -->
    <a href="https://www.canva.com/design/DAG8MAjIFG8/weho4u_KkA5rmRxbUlOmCA/edit?utm_content=DAG8MAjIFG8&utm_campaign=designshare&utm_medium=link2&utm_source=sharebutton" target="_blank" rel="noopener noreferrer" class="block">
    <section class="bg-palette-pink py-10 md:py-16 px-4 md:px-8 hover:bg-palette-pink/90 transition-colors cursor-pointer">
        <div class="max-w-4xl mx-auto flex flex-col items-center">
            <div class="text-left w-full max-w-[90vw] md:max-w-none">
                <p class="text-white uppercase tracking-[0.2em] md:tracking-[0.3em] font-bold mb-0 text-[10pt] md:text-[15pt]" style="font-family: 'Montserrat', sans-serif;">PLATAFORMA</p>
                <h2 class="text-palette-yellow drop-shadow-lg mb-3 md:mb-4 text-[60pt] md:text-[90pt] lg:text-[120pt]" style="font-family: 'LanceAPLP', 'Impact', sans-serif; line-height: 0.9;">Puente</h2>
                <p class="text-white text-center text-[12pt] md:text-[15pt] leading-relaxed max-w-md md:max-w-none" style="font-family: 'Merriweather Sans', sans-serif;">Plataforma de fortalecimiento y agencia<br class="md:hidden"> de organizaciones en territorio</p>
                <p class="text-white/80 text-center text-[10pt] md:text-[12pt] mt-4 flex items-center justify-center gap-2" style="font-family: 'Montserrat', sans-serif;"><i class="fas fa-external-link-alt"></i> Ver presentación completa</p>
            </div>
        </div>
    </section>
    </a>

    <footer class="text-center py-8 text-palette-dark opacity-60 text-xs">
        <p>Equipo de Fortalecimiento del Ecosistema Cultural y Comunitario • Diciembre 2025</p>
    </footer>

    <!-- DASHBOARD MODAL -->
    <div id="dashboard-modal" class="fixed inset-0 z-[2000] hidden bg-palette-dark/90 backdrop-blur-sm items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none" style="display: none;">
        <div class="bg-white rounded-3xl w-full max-w-5xl max-h-[90vh] overflow-y-auto p-6 relative shadow-2xl transform scale-95 transition-transform duration-300">
            <button onclick="toggleDashboard()" class="absolute top-4 right-4 text-palette-dark hover:text-palette-pink text-2xl transition-colors"><i class="fas fa-times"></i></button>
            
            <h2 class="text-3xl font-black text-palette-dark mb-2">DISTRIBUCIÓN DEL RECURSO</h2>
            <p class="text-gray-500 mb-8 text-sm">Distribución de recursos y beneficiarios por líneas estratégicas y territorio.</p>

            <div class="grid grid-cols-1 gap-8">
                <!-- Chart 1: Inversión por Red -->
                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100 shadow-sm">
                    <h4 class="font-bold text-center mb-4 text-palette-deepPurple text-sm uppercase tracking-wider">Porcentaje de inversión por rubro</h4>
                    <div class="h-64 relative"><canvas id="chart-investment"></canvas></div>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mt-8">
                 <div class="bg-palette-pink/10 p-3 rounded-xl text-center border border-palette-pink/20">
                    <div class="text-xl md:text-2xl font-black text-palette-pink" id="stat-orgs">105</div>
                    <div class="text-[9px] md:text-[10px] uppercase font-bold opacity-60">Org. fortalecidas</div>
                 </div>
                 <div class="bg-green-100 p-3 rounded-xl text-center border border-green-200">
                    <div class="text-xl md:text-2xl font-black text-green-600">45</div>
                    <div class="text-[9px] md:text-[10px] uppercase font-bold opacity-60">Otros apoyos</div>
                 </div>
                 <div class="bg-palette-blue/10 p-3 rounded-xl text-center border border-palette-blue/20">
                    <div class="text-xl md:text-2xl font-black text-palette-blue" id="stat-cities">0</div>
                    <div class="text-[9px] md:text-[10px] uppercase font-bold opacity-60">Territorios</div>
                 </div>
                 <div class="bg-palette-yellow/10 p-3 rounded-xl text-center border border-palette-yellow/20">
                    <div class="text-xl md:text-2xl font-black text-palette-yellow" id="stat-events">0</div>
                    <div class="text-[9px] md:text-[10px] uppercase font-bold opacity-60">Eventos</div>
                 </div>
                 <div class="bg-palette-purple/10 p-3 rounded-xl text-center border border-palette-purple/20 col-span-2 md:col-span-1">
                    <div class="text-sm md:text-base font-black text-palette-purple truncate" id="stat-avg">$0</div>
                    <div class="text-[9px] md:text-[10px] uppercase font-bold opacity-60" title="Valor total del convenio (cifra fija).">Total convenio</div>
                 </div>
            </div>
        </div>
    </div>

    <!-- LÓGICA DEL MAPA -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
    
    <script>
    // --- DATOS DE LA GALERÍA ---
    // Se usan enlaces directos a Google Drive (lh3.googleusercontent.com) generados a partir de los IDs.
    const galleryData = [
        { org: 'Asociación de Mujeres Wiwa Abu Dzibu', project: 'Encuentro intercultural de mujeres indígenas Wiwa', city: 'Santa Marta', img: '../assets/img/gallery/Asociacion_de_Mujeres_Wiwa_Abu_Dzibu.jpg' },
        { org: 'ORVIEN (Víctimas Río Iró)', project: 'Rescate Tradiciones y Costumbres Ancestrales', city: 'Río Iró', img: '../assets/img/gallery/ORVIEN__Victimas_Rio_Iro_.jpg' },
        { org: 'FUNDACION MICELIO', project: 'III Versión del Festival Ancestral Zenú', city: 'Corozal', img: '../assets/img/gallery/FUNDACION_MICELIO.jpg' },
        { org: 'COMPAÑÍA AMÉRICA DANZA', project: 'Danza, Movimientos y Emociones', city: 'Soacha', img: '../assets/img/gallery/COMPANIA_AMERICA_DANZA.jpg' },
        { org: 'FUNDACIÓN PATERPAUTT', project: 'Arte Restaurativo', city: 'Montería', img: '../assets/img/gallery/FUNDACION_PATERPAUTT.jpg' },
        { org: 'Asociación de Vecinos Granjas de San Pablo ASOVEG', project: 'Fortalecer Artesanos Construyendo Sentido Social', city: 'Bogotá', img: '../assets/img/gallery/Asociacion_de_Vecinos_Granjas_de_San_Pablo_ASOVEG.jpg' },
        { org: 'Corporación Errante Lab', project: 'Policromía en juntanza', city: 'Ocaña', img: '../assets/img/gallery/Corporacion_Errante_Lab.jpg' },
        { org: 'Asociación de mujeres triunfadoras tejiendo vida', project: 'Amazonit@s en Escena', city: 'Leticia', img: '../assets/img/gallery/Asociacion_de_mujeres_triunfadoras_tejiendo_vida.jpg' },
        { org: 'Fundación el hogar de tota', project: 'Cadenas de Libertad', city: 'Montería', img: '../assets/img/gallery/Fundacion_el_hogar_de_tota.jpg' },
        { org: 'asociacion de mujeres casa del sembrador', project: 'Retazos de Vida', city: 'Arauca', img: '../assets/img/gallery/asociacion_de_mujeres_casa_del_sembrador.jpg' },
        { org: 'FUNDACION CULTURAL KYNZA XIE', project: 'Escuela de Saberes Hilos de Luna', city: 'Chía', img: '../assets/img/gallery/FUNDACION_CULTURAL_KYNZA_XIE.jpg' },
        { org: 'Corporación violeta en movimiento', project: 'Venus Fest', city: 'Pasto', img: '../assets/img/gallery/Corporacion_violeta_en_movimiento.jpg' },
        { org: 'Corporación para el desarrollo coral de Buga, Corpacoros', project: '30o. Encuentro de música coral', city: 'Ocaña', img: '../assets/img/gallery/Corporacion_para_el_desarrollo_coral_de_Buga__Corpacoros.jpg' },
        { org: 'Corporación SIN FRONTERAS', project: 'BARRANCABERMEJA LE CANTA A LA PAZ', city: 'Tijuana', img: '../assets/img/gallery/Corporacion_SIN_FRONTERAS.jpg' },
        { org: 'Tierra Pazifica/BOICOP', project: 'FORTALECIMIENTO RED CULTURAL BIOCOP', city: 'Cali', img: '../assets/img/gallery/Tierra_Pazifica_BOICOP.jpg' },
        { org: 'COPORACION DE DANZA DINASTIA NEGRA', project: 'FESTIREDU', city: 'Apartadó', img: '../assets/img/gallery/COPORACION_DE_DANZA_DINASTIA_NEGRA.jpg' },
        { org: 'CORPORACION ULRIKA', project: 'Obra literaria de Raúl Gómez Jattin', city: 'Bogotá', img: '../assets/img/gallery/CORPORACION_ULRIKA.jpg' },
        { org: 'FUNDACION UNIDOS POR EL DESARROLLO COMUNITARIO', project: 'ENCUENTRO MUNICIPAL DE DANZAS SOY PELAYERO', city: 'Corozal', img: '../assets/img/gallery/FUNDACION_UNIDOS_POR_EL_DESARROLLO_COMUNITARIO.jpg' },
        { org: 'afroresilientes', project: 'Circuito de formación en música y danza', city: 'Santa Marta', img: '../assets/img/gallery/afroresilientes.jpg' },
        { org: 'Coral Santa María', project: 'Coro a la plaza - La Música te alimenta', city: 'Manizales', img: '../assets/img/gallery/Coral_Santa_Maria.jpg' },
        { org: 'Fundación Socio Cultural La Nana', project: 'XXVIII FESTIVAL REGIONAL DE TEATRO', city: 'Montería', img: '../assets/img/gallery/Fundacion_Socio_Cultural_La_Nana.jpg' },
        { org: 'FUNDACIÓN UN MAR DE VOCES', project: 'ESCUELA CORAL UN MAR DE VOCES', city: 'Cali', img: '../assets/img/gallery/FUNDACION_UN_MAR_DE_VOCES.jpg' },
        { org: 'ASOCIACION DE CAVILDOS INDIGENAS IPIALES', project: 'CONCURSO DEPARTAMENTAL DE BANDAS', city: 'Gutiérrez', img: '../assets/img/gallery/ASOCIACION_DE_CAVILDOS_INDIGENAS_IPIALES.jpg' },
        { org: 'Corporación CorArte', project: 'Armonías de Buga', city: 'Ocaña', img: '../assets/img/gallery/Corporacion_CorArte.jpg' },
        { org: 'Fundación movimiento Hip Hop Ipiales', project: 'Festival binacional de Hip Hop', city: 'Pasto', img: '../assets/img/gallery/Fundacion_movimiento_Hip_Hop_Ipiales.jpg' },
        { org: 'FUNDACIÓN CULTURAL NEWSPAPER', project: 'RITMO, CONCIENCIA Y PAZ', city: 'Chía', img: '../assets/img/gallery/FUNDACION_CULTURAL_NEWSPAPER.jpg' },
        { org: 'Corporación Cultural CK - Casa Kolacho', project: 'Hip Hop Vida', city: 'Ocaña', img: '../assets/img/gallery/Corporacion_Cultural_CK___Casa_Kolacho.jpg' },
        { org: 'Fundación escuela de arte el círculo Hip Hop', project: 'Hip Hop transformando territorios', city: 'Montería', img: '../assets/img/gallery/Fundacion_escuela_de_arte_el_circulo_Hip_Hop.jpg' },
        { org: 'Fundación Cultura, Paz y Territorio', project: 'FORTALECIMIENTO HIP-HOP DE IBAGUÉ', city: 'Montería', img: '../assets/img/gallery/Fundacion_Cultura__Paz_y_Territorio.jpg' },
        { org: 'Fundación Surprise City', project: 'Nariño es Hip Hop', city: 'Montería', img: '../assets/img/gallery/Fundacion_Surprise_City.jpg' },
        { org: 'Corporación Casabeat', project: 'Calibeat Hip Hop Festival IV', city: 'Medellín', img: '../assets/img/gallery/Corporacion_Casabeat.jpg' },
        { org: 'Fundación 5ta con 5ta crew', project: 'Del Norte Bravos Hijos', city: 'Montería', img: '../assets/img/gallery/Fundacion_5ta_con_5ta_crew.jpg' },
        { org: 'RapJudesco', project: 'Fortalecimiento procesos RapJudesco', city: 'Colombia', img: '../assets/img/gallery/RapJudesco.jpg' },
        { org: 'JAC AGUA BONITA 2', project: 'El graffiti como expresión politica', city: 'Cali', img: '../assets/img/gallery/JAC_AGUA_BONITA_2.jpg' },
        { org: 'Asociación Hip Hop por Nuestra Tierra', project: 'La Gente Atenta', city: 'Santa Marta', img: '../assets/img/gallery/Asociacion_Hip_Hop_por_Nuestra_Tierra.jpg' },
        { org: 'Colectivo Hip Hop por la Vida', project: 'Festival Hip Hop por la Vida', city: 'Colombia', img: '../assets/img/gallery/Colectivo_Hip_Hop_por_la_Vida.jpg' },
        { org: 'FUNDACIÓN BUENAVENTURA HIP HOP', project: 'Embajadores de paz', city: 'Buenaventura', img: '../assets/img/gallery/FUNDACION_BUENAVENTURA_HIP_HOP.jpg' },
        { org: 'La Casa del bardo', project: 'Convocatoria Caos Vol.2', city: 'Ibagué', img: '../assets/img/gallery/La_Casa_del_bardo.jpg' },
        { org: 'Montaña Récords Catatumbo', project: 'CARRANGA SCHOOL', city: 'Colombia', img: '../assets/img/gallery/Montana_Records_Catatumbo.jpg' },
        { org: 'Fundación Hip Hop Peña', project: 'Cali, Ciudad Hip Hop', city: 'Montería', img: '../assets/img/gallery/Fundacion_Hip_Hop_Pena.jpg' },
        { org: 'Corporacion La Tigra', project: 'Festival de La Tigra', city: 'Ocaña', img: '../assets/img/gallery/Corporacion_La_Tigra.jpg' },
        { org: 'CORPORACIÓN INFLUENCERS ÉTNICOS', project: 'ESCUELA DE FORMACIÓN AUDIOVISUAL', city: 'San Basilio', img: '../assets/img/gallery/CORPORACION_INFLUENCERS_ETNICOS.jpg' },
        { org: 'Parchemos por Yacopí', project: 'Festival Resonar el territorio', city: 'Colombia', img: '../assets/img/gallery/Parchemos_por_Yacopi.jpg' },
        { org: 'Corporación Arreglando el País', project: 'Vientos del Macizo', city: 'Pitalito', img: '../assets/img/gallery/Corporacion_Arreglando_el_Pais.jpg' },
        { org: 'Fundacion Pacifica Cultural', project: 'Memorias Sonoras del Estallido', city: 'Barrancabermeja', img: '../assets/img/gallery/Fundacion_Pacifica_Cultural.jpg' },
        { org: 'La Minga Muralista Kamentsa', project: 'El arte urbano como herramienta', city: 'Istmina', img: '../assets/img/gallery/La_Minga_Muralista_Kamentsa.jpg' },
        { org: 'Corporación rey de la selva', project: 'Festival rugido social', city: 'Ocaña', img: '../assets/img/gallery/Corporacion_rey_de_la_selva.jpg' },
        { org: 'CORPORACIÓN CÓDIGO ESTILO CREW', project: 'EL PARCHE JUVENIL DEL QUINDÍO', city: 'Armenia', img: '../assets/img/gallery/CORPORACION_CODIGO_ESTILO_CREW.jpg' },
        { org: 'Comunicación Visual Sin Fronteras', project: 'La COSMOVISIÓN DE LA ETNIA MAGÜTA', city: 'Buga', img: '../assets/img/gallery/Comunicacion_Visual_Sin_Fronteras.jpg' },
        { org: 'The Giants Community', project: 'Cali Capital Festival Juvenil', city: 'Cali', img: '../assets/img/gallery/The_Giants_Community.jpg' },
        { org: 'Org. Desarrollo Ecosistemas Culturales', project: 'Agenda Juvenil de Impulso a las Artes', city: 'San Pelayo', img: '../assets/img/gallery/Org__Desarrollo_Ecosistemas_Culturales.jpg' },
        { org: 'corpohuellas', project: 'bari rock festival 2025', city: 'Buga', img: '../assets/img/gallery/corpohuellas.jpg' },
        { org: 'Corporación Calina Cumbay', project: 'Escuelas bioculturales', city: 'Ocaña', img: '../assets/img/gallery/Corporacion_Calina_Cumbay.jpg' },
        { org: 'Corporación Yukuta', project: 'Sonido Nativo', city: 'Medellín', img: '../assets/img/gallery/Corporacion_Yukuta.jpg' },
        { org: 'NUEVO ESTILO DANCE', project: 'RUTA DEL RITMO', city: 'Cali', img: '../assets/img/gallery/NUEVO_ESTILO_DANCE.jpg' },
        { org: 'Corporación Emergiendo', project: 'NARRATIVAS URBANAS MANIZALES', city: 'Viterbo', img: '../assets/img/gallery/Corporacion_Emergiendo.jpg' },
        { org: 'FUNDACION MANGLARIA DIVERSA', project: 'Red de Ritmos para la Paz', city: 'Tumaco', img: '../assets/img/gallery/FUNDACION_MANGLARIA_DIVERSA.jpg' },
        { org: 'Jóvenes creadores del chocó', project: 'SABERES QUE TRANSFORMAN', city: 'Quibdó', img: '../assets/img/gallery/Jovenes_creadores_del_choco.jpg' },
        { org: 'Corporación Fahrenheit 451', project: 'Pacificarte', city: 'Ocaña', img: '../assets/img/gallery/Corporacion_Fahrenheit_451.jpg' },
        { org: 'Fundacion Amahía', project: 'Tercer Laboratorio de Denuncia Creativa', city: 'Montería', img: '../assets/img/gallery/Fundacion_Amahia.jpg' },
        { org: 'Medance - Ritmo Extremo REX', project: 'Juventud en movimiento', city: 'Colombia', img: '../assets/img/gallery/Medance___Ritmo_Extremo_REX.jpg' },
        { org: 'Fundación Linderos de Paz', project: 'Ritmos y pasos hacia La Paz integral', city: 'Montería', img: '../assets/img/gallery/Fundacion_Linderos_de_Paz.jpg' },
        { org: 'MUSIQULTURA', project: 'Rescatando Lo Nuestro', city: 'Cali', img: '../assets/img/gallery/MUSIQULTURA.jpg' },
        { org: 'RED PENSAMIENTO LATINOAMERICANO', project: 'CIRCULACIÓN DANZA TEATRO', city: 'Tocancipá', img: '../assets/img/gallery/RED_PENSAMIENTO_LATINOAMERICANO.jpg' },
        { org: 'Corporaciòn Vida-Paz', project: 'Cultura y Biodiversidad', city: 'Viterbo', img: '../assets/img/gallery/Corporacion_Vida_Paz.jpg' },
        { org: 'KOMBILESA MÍ', project: 'LA MÚSICA Y LA DANZA...', city: 'San Basilio', img: '../assets/img/gallery/KOMBILESA_MI.jpg' },
        { org: 'Guaque - Territorialidades S.A.S', project: 'Quycagua ‘El Tejido de los Pueblos’', city: 'Sopó', img: '../assets/img/gallery/Guaque___Territorialidades_S_A_S.jpg' },
        { org: 'Corporación Elements', project: 'Crew Peligrosos y 4Eskuela', city: 'Medellín', img: '../assets/img/gallery/Corporacion_Elements.jpg' }
    ];

    // --- LÓGICA DE LA GALERÍA ---
    let currentSlide = 0;
    let slideInterval;
    let isPlaying = true;
    let isGridView = false;

    // Helper to get thumbnail path from full image path
    function getThumbPath(imgPath) {
        // ../assets/img/gallery/image.jpg -> ../assets/img/gallery/thumbs/image.jpg
        return imgPath.replace('/gallery/', '/gallery/thumbs/');
    }

    function initCarousel() {
        const container = document.getElementById('gallery-container');
        if(!container) return;
        renderCarouselView();
        startSlideShow();
    }

        function renderCarouselView() {
        const container = document.getElementById('gallery-container');
        const isFullscreen = !!document.fullscreenElement;
        
        container.className = 'w-full h-full relative overflow-hidden bg-black flex items-center justify-center';
        
        // In fullscreen: fill screen completely while maintaining aspect ratio
        // Normal mode: constrain to container
        const imgClass = isFullscreen 
            ? "w-full h-full object-contain" 
            : "max-w-full max-h-full object-contain shadow-2xl";

        container.innerHTML = galleryData.map((item, index) => `
            <div class="carousel-slide absolute inset-0 transition-all duration-700 ease-in-out flex items-center justify-center ${index === currentSlide ? 'opacity-100 z-10' : 'opacity-0 z-0 pointer-events-none'}" 
                 data-index="${index}">
                
                <!-- Image fills container in fullscreen -->
                <div class="relative w-full h-full flex items-center justify-center">
                    <img src="${item.img}" alt="${item.org}" 
                         class="${imgClass}"
                         onclick="zoomToFromGallery('${item.org.replace(/'/g, "\\'")}')">
                    
                    <!-- Caption (Bottom Right of the container) -->
                    <div class="absolute bottom-0 right-0 p-4 md:p-8 text-right max-w-md bg-gradient-to-t from-black/90 via-black/50 to-transparent rounded-tl-3xl pointer-events-none">
                        <div class="pointer-events-auto cursor-pointer group" onclick="zoomToFromGallery('${item.org.replace(/'/g, "\\'")}')">
                            
                            <!-- Location Badge -->
                            <div class="inline-flex items-center gap-2 text-xs font-bold bg-palette-pink/90 text-white px-3 py-1 rounded-full mb-2 shadow-lg justify-end ml-auto">
                                <i class="fas fa-map-marker-alt"></i> ${item.city || 'Colombia'}
                            </div>

                            <!-- Org Name -->
                            <h3 class="text-xl md:text-2xl lg:text-3xl font-black uppercase leading-tight text-palette-yellow drop-shadow-xl mb-1 group-hover:text-white transition-colors">
                                ${item.org}
                            </h3>

                            <!-- Project Name -->
                            <p class="text-sm md:text-base lg:text-lg font-medium text-gray-200 border-r-4 border-palette-pink pr-4 mb-1">
                                ${item.project}
                            </p>
                            
                            <div class="text-xs text-gray-400 mt-1 flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                Clic para ubicar en el mapa <i class="fas fa-search-location"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('gallery-nav-controls').classList.remove('hidden');
        document.getElementById('btn-play-pause').classList.remove('hidden');
    }

    function renderGridView() {
        const container = document.getElementById('gallery-container');
        container.className = 'w-full h-full bg-palette-dark p-4 overflow-y-auto custom-scrollbar grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 content-start auto-rows-min';
        
        // Use thumbnails for grid view (much smaller file sizes for faster loading)
        container.innerHTML = galleryData.map((item, index) => `
            <div class="flex flex-col gap-1 group/item cursor-pointer hover:scale-[1.02] transition-transform" onclick="selectFromGrid(${index})">
                <div class="relative aspect-square rounded-lg overflow-hidden ring-2 ring-transparent group-hover/item:ring-palette-pink transition-all shadow-lg bg-black/50">
                    <img src="${getThumbPath(item.img)}" 
                         alt="${item.org}"
                         class="w-full h-full object-cover transition-transform duration-300 group-hover/item:scale-110" 
                         loading="lazy"
                         onerror="this.src='${item.img}'">
                </div>
                <div class="text-center px-1 py-1">
                    <h4 class="text-white text-[11px] font-bold uppercase leading-tight group-hover/item:text-palette-yellow transition-colors line-clamp-2">${item.org}</h4>
                    <p class="text-[10px] text-gray-400 mt-0.5 font-medium leading-tight line-clamp-1">${item.project}</p>
                </div>
            </div>
        `).join('');

        document.getElementById('gallery-nav-controls').classList.add('hidden');
        document.getElementById('btn-play-pause').classList.add('hidden');
    }

    function toggleGridView() {
        isGridView = !isGridView;
        if(isGridView) {
            stopSlideShow();
            renderGridView();
        } else {
            renderCarouselView();
            startSlideShow();
        }
    }

    function selectFromGrid(index) {
        currentSlide = index;
        isGridView = false; // Force carousel mode
        renderCarouselView(); // Re-render carousel
        startSlideShow();
    }

    function showSlide(index) {
        if(isGridView) return;
        const slides = document.querySelectorAll('.carousel-slide');
        if(!slides.length) return;
        
        // Hide current
        slides[currentSlide].classList.remove('opacity-100', 'z-10');
        slides[currentSlide].classList.add('opacity-0', 'z-0', 'pointer-events-none');
        
        // Update index
        currentSlide = (index + slides.length) % slides.length;
        
        // Show new
        slides[currentSlide].classList.remove('opacity-0', 'z-0', 'pointer-events-none');
        slides[currentSlide].classList.add('opacity-100', 'z-10');
    }

    function moveSlide(step) {
        showSlide(currentSlide + step);
        resetTimer();
    }

    function startSlideShow() {
        stopSlideShow();
        if(!isGridView) {
            slideInterval = setInterval(() => moveSlide(1), 5000);
            isPlaying = true;
            updatePlayBtn();
        }
    }

    function stopSlideShow() {
        clearInterval(slideInterval);
        isPlaying = false;
        updatePlayBtn();
    }

    function resetTimer() {
        if(isPlaying && !isGridView) startSlideShow();
    }

    function toggleCarouselPlay() {
        if(isPlaying) stopSlideShow();
        else startSlideShow();
    }

    function updatePlayBtn() {
        const btn = document.getElementById('btn-play-pause');
        if(btn) btn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
    }

    function toggleCarouselFullscreen() {
        const elem = document.getElementById('photo-gallery-section');
        if (!document.fullscreenElement) {
            elem.requestFullscreen().catch(err => console.log(err));
            elem.classList.remove('rounded-[2rem]');
            // Force resize event or re-render if needed
            setTimeout(() => {
                if(!isGridView) renderCarouselView();
            }, 100);
        } else {
            document.exitFullscreen();
            elem.classList.add('rounded-[2rem]');
            setTimeout(() => {
                if(!isGridView) renderCarouselView();
            }, 100);
        }
    }

    // --- TOUCH / SWIPE SUPPORT ---
    let touchStartX = 0;
    let touchEndX = 0;

    function initSwipe() {
        const container = document.getElementById('gallery-container');
        
        container.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});

        container.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});
    }

    function handleSwipe() {
        if (isGridView) return;
        const threshold = 50; // min distance
        if (touchEndX < touchStartX - threshold) {
            moveSlide(1); // Swipe Left -> Next
        }
        if (touchEndX > touchStartX + threshold) {
            moveSlide(-1); // Swipe Right -> Prev
        }
    }

    function zoomToFromGallery(orgName) {
        if (document.fullscreenElement) {
            document.exitFullscreen().then(() => performZoom(orgName));
        } else {
            performZoom(orgName);
        }
    }

    function performZoom(orgName) {
        const mapEl = document.getElementById('map-wrapper');
        mapEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
            if(window.zoomTo) window.zoomTo(orgName);
        }, 600);
    }

    document.addEventListener('DOMContentLoaded', function() {
        initCarousel();
        initSwipe();
        
        // 1. DATA COMPLETA (91 ORGANIZACIONES)
        const organizations = [
            // --- RED DE MUJERES (REMAG) ---
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'Chaibá, Fundación', city: 'Suesca', lat: 5.103, lng: -73.800, contribution: 15000000, events: [{ name: 'Festival Titúa', type: 'CIRCULACIÓN', ben: 500 }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'FUNDACION CULTURAL KYNZA XIE', city: 'Chía', lat: 4.858, lng: -74.033, contribution: 20000000, events: [{ name: 'Muestra final Escuela', type: 'CIRCULACIÓN', ben: 256 }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'Asociación Wiwa Abudzibu', city: 'Santa Marta', lat: 11.240, lng: -74.199, contribution: 20000000, events: [{ name: 'Encuentro danzas tradicionales', type: 'CIRCULACIÓN', ben: 43 }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'ORVIEN (Víctimas Río Iró)', city: 'Río Iró', lat: 5.217, lng: -76.683, contribution: 20000000, events: [{ name: 'Encuentro cultural', type: 'CIRCULACIÓN', ben: 2440 }, { name: 'Conversatorios comunidad', type: 'CIRCULACIÓN' }, { name: 'Encuentro juegos', type: 'CIRCULACIÓN' }, { name: 'Encuentro sanadoras', type: 'CIRCULACIÓN' }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'FUNDACION MICELIO', city: 'Corozal', lat: 9.316, lng: -75.294, contribution: 20000000, events: [{ name: 'Encuentro danzas ancestrales', type: 'CIRCULACIÓN', ben: 2050 }, { name: 'Conversatorio saberes', type: 'CIRCULACIÓN' }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'COMPAÑÍA AMÉRICA DANZA', city: 'Soacha', lat: 4.580, lng: -74.217, contribution: 40000000, events: [{ name: 'Feria Comunitaria', type: 'CIRCULACIÓN', ben: 98 }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'FUNDACION DECUPLUM', city: 'Valledupar', lat: 10.463, lng: -73.253, contribution: 50000000, events: [{ name: 'Encuentro Vallenato Femenino', type: 'CIRCULACIÓN', ben: 115 }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'FUNDACIÓN PATERPAUTT', city: 'Montería', lat: 8.755, lng: -75.887, contribution: 20000000, events: [{ name: 'Arte Restaurativo', type: 'CIRCULACIÓN' }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'Asociación de Vecinos Granjas de San Pablo ASOVEG', city: 'Bogotá', lat: 4.711, lng: -74.072, contribution: 30000000, events: [{ name: 'Fortalecer Artesanos', type: 'CIRCULACIÓN' }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'Corporación Errante Lab', city: 'Ocaña', lat: 8.237, lng: -73.355, contribution: 20000000, events: [{ name: 'Policromía en juntanza', type: 'CIRCULACIÓN' }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'Asociación de mujeres triunfadoras tejiendo vida', city: 'Leticia', lat: -4.215, lng: -69.941, contribution: 20000000, events: [{ name: 'Amazonit@s en Escena', type: 'CIRCULACIÓN' }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'Fundación el hogar de tota', city: 'Montería', lat: 8.755, lng: -75.887, contribution: 20000000, events: [{ name: 'Cadenas de Libertad', type: 'CIRCULACIÓN' }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'asociacion de mujeres casa del sembrador', city: 'Arauca', lat: 7.084, lng: -70.759, contribution: 20000000, events: [{ name: 'Retazos de Vida', type: 'CIRCULACIÓN' }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'Corporación violeta en movimiento', city: 'Pasto', lat: 1.213, lng: -77.281, contribution: 20000000, events: [{ name: 'Venus Fest', type: 'CIRCULACIÓN' }] },
            { network: 'Red de mujeres artistas y gestoras REMAG', name: 'Fundación Atrapa-sueños', city: 'Arauca', lat: 7.084, lng: -70.759, contribution: 20000000, events: [{ name: 'Actividades culturales', type: 'CIRCULACIÓN' }] },

            // --- RED INTERCULTURAL JUVENIL ---
            { network: 'Red Intercultural Juvenil', name: 'ASOCIACION RESONANCIA', city: 'Tocancipá', lat: 4.966, lng: -73.916, contribution: 45000000, events: [{ name: 'Mapeo participativo', type: 'FORMACIÓN', ben: 30 }, { name: 'Jornadas formativas', type: 'FORMACIÓN', ben: 40 }, { name: 'Evento de cierre: Redes que Fluyen', type: 'CIRCULACIÓN', ben: 300 }] },
            { network: 'Red Intercultural Juvenil', name: 'FAHRENHEIT 451', city: 'Chía', lat: 4.858, lng: -74.058, contribution: 80000000, events: [{ name: 'Talleres artísticos', type: 'FORMACIÓN', ben: 50 }, { name: 'Salidas de convivio', type: 'FORMACIÓN', ben: 50 }, { name: 'Clases de apoyo', type: 'FORMACIÓN', ben: 45 }, { name: 'Festival Pacificarte', type: 'CIRCULACIÓN', ben: 400 }] },
            { network: 'Red Intercultural Juvenil', name: 'INFLUENCERS ETNICOS', city: 'San Basilio', lat: 10.105, lng: -75.198, contribution: 40000000, events: [{ name: 'Talleres Audiovisual', type: 'FORMACIÓN', ben: 30 }, { name: 'Laboratorios creativos', type: 'FORMACIÓN', ben: 30 }, { name: 'Lanzamiento Plataformas', type: 'CIRCULACIÓN', ben: 150 }, { name: 'Encuentro comunitario', type: 'PUBLICO', ben: 60 }, { name: 'Estrategia circulación', type: 'CIRCULACIÓN', ben: 30 }, { name: 'Encuentro intergeneracional', type: 'PUBLICO', ben: 50 }, { name: 'Encuentro Red Juvenil', type: 'PUBLICO', ben: 40 }, { name: 'Taller final', type: 'PUBLICO', ben: 100 }] },
            { network: 'Red Intercultural Juvenil', name: 'AMBIENTALISTAS DE CORAZÓN', city: 'Tocancipá', lat: 4.966, lng: -73.916, contribution: 45000000, events: [{ name: 'Festival Biohoty', type: 'FORMACIÓN', ben: 120 }, { name: 'Comparsa y Ritual', type: 'CIRCULACIÓN', ben: 500 }, { name: 'Talleres formación', type: 'FORMACIÓN', ben: 80 }, { name: 'Shows artísticos', type: 'CIRCULACIÓN', ben: 600 }, { name: 'Conversatorios cierre', type: 'FORMACIÓN', ben: 60 }] },
            { network: 'Red Intercultural Juvenil', name: 'FUNDACIÓN RIMARTE', city: 'Cali', lat: 3.451, lng: -76.532, contribution: 50000000, events: [{ name: 'Taller Iniciación', type: 'FORMACIÓN', ben: 30 }, { name: 'Laboratorio Composición', type: 'FORMACIÓN', ben: 25 }, { name: 'Ensayo Abierto', type: 'PUBLICO', ben: 80 }, { name: 'Grabación y producción', type: 'FORMACIÓN', ben: 10 }, { name: 'Foro con Referentes', type: 'FORMACIÓN', ben: 60 }, { name: 'Evento Voces que nacen', type: 'CIRCULACIÓN', ben: 250 }] },
            { network: 'Red Intercultural Juvenil', name: 'ALAS Y RAÍCES', city: 'La Belleza', lat: 5.860, lng: -73.968, contribution: 45000000, events: [{ name: 'Residencias artísticas', type: 'FORMACIÓN', ben: 20 }, { name: 'Taller cartografía', type: 'FORMACIÓN', ben: 50 }, { name: 'Pintura murales', type: 'PUBLICO', ben: 150 }, { name: 'Talleres Bioculturales', type: 'FORMACIÓN', ben: 200 }, { name: 'Producción fanzines', type: 'FORMACIÓN', ben: 40 }] },
            { network: 'Red Intercultural Juvenil', name: 'NUEVO ESTILO DANCE', city: 'Cali', lat: 3.451, lng: -76.532, contribution: 30000000, events: [{ name: 'Talleres formación', type: 'FORMACIÓN', ben: 100 }, { name: 'Formación avanzada', type: 'FORMACIÓN', ben: 30 }, { name: 'Ensayos show', type: 'FORMACIÓN', ben: 50 }, { name: 'Laboratorio danza', type: 'FORMACIÓN', ben: 30 }, { name: 'Ruta turística Siloé', type: 'PUBLICO', ben: 60 }, { name: 'Encuentro cultural', type: 'CIRCULACIÓN', ben: 300 }] },
            { network: 'Red Intercultural Juvenil', name: 'Guaque/Territorialidades', city: 'Sopó', lat: 4.908, lng: -73.938, contribution: 45000000, events: [{ name: 'Residencias Artísticas', type: 'FORMACIÓN', ben: 50 }, { name: 'Talleres Arte Urbano', type: 'FORMACIÓN', ben: 25 }, { name: 'Festival QUYCAGUA', type: 'CIRCULACIÓN', ben: 800 }] },
            { network: 'Red Intercultural Juvenil', name: 'FUTURO DE LA GUAJIRA', city: 'Riohacha', lat: 11.544, lng: -72.907, contribution: 80000000, events: [{ name: 'Talleres danza', type: 'FORMACIÓN', ben: 30 }, { name: 'Laboratorio oralidad', type: 'FORMACIÓN', ben: 20 }, { name: 'Fogata literaria', type: 'PUBLICO', ben: 50 }, { name: 'Laboratorios visuales', type: 'FORMACIÓN', ben: 60 }, { name: 'Exposición cierre', type: 'CIRCULACIÓN', ben: 200 }] },
            { network: 'Red Intercultural Juvenil', name: 'Jóvenes Creadores Chocó', city: 'Quibdó', lat: 5.694, lng: -76.661, contribution: 60000000, events: [{ name: 'Formación danza', type: 'FORMACIÓN', ben: 45 }, { name: 'Comparsa San Pacho', type: 'CIRCULACIÓN', ben: 600 }, { name: 'Evento danza', type: 'CIRCULACIÓN', ben: 200 }] },
            { network: 'Red Intercultural Juvenil', name: 'CÓDIGO ESTILO CREW', city: 'Armenia', lat: 4.533, lng: -75.681, contribution: 50000000, events: [{ name: 'Parche de Juventudes', type: 'CIRCULACIÓN', ben: 400 }, { name: 'Caravana Juvenil', type: 'CIRCULACIÓN', ben: 250 }, { name: 'Ciclos formativos', type: 'FORMACIÓN', ben: 30 }] },
            { network: 'Red Intercultural Juvenil', name: 'RED CEPELA', city: 'Mutatá', lat: 7.243, lng: -76.436, contribution: 50000000, events: [{ name: 'Festival Selva Adentro', type: 'CIRCULACIÓN', ben: 400 }, { name: 'Talleres danza-teatro', type: 'FORMACIÓN', ben: 35 }] },
            { network: 'Red Intercultural Juvenil', name: 'REY DE LA SELVA', city: 'Quibdó', lat: 5.696, lng: -76.661, contribution: 40000000, events: [{ name: 'Semilleros Freestyle', type: 'FORMACIÓN', ben: 50 }, { name: 'Festival Rugido Social', type: 'CIRCULACIÓN', ben: 800 }] },
            { network: 'Red Intercultural Juvenil', name: 'ECOSISTEMAS CULTURALES', city: 'Luruaco', lat: 10.612, lng: -75.146, contribution: 80000000, events: [{ name: 'Talleres economía', type: 'FORMACIÓN', ben: 25 }, { name: 'Festival Música', type: 'CIRCULACIÓN', ben: 500 }, { name: 'Festival Picotero', type: 'CIRCULACIÓN', ben: 700 }, { name: 'Muralismo comunitario', type: 'PUBLICO', ben: 100 }] },
            { network: 'Red Intercultural Juvenil', name: 'The Giants Community', city: 'Cali', lat: 3.451, lng: -76.532, contribution: 80000000, events: [{ name: 'Encuentro Danza Urbana', type: 'CIRCULACIÓN', ben: 300 }, { name: 'Showcase / Batallas', type: 'CIRCULACIÓN', ben: 1000 }, { name: 'Conversatorios', type: 'FORMACIÓN', ben: 80 }] },
            { network: 'Red Intercultural Juvenil', name: 'Corporación Emergiendo', city: 'Viterbo', lat: 5.066, lng: -75.883, contribution: 50000000, events: [{ name: 'Intervenciones murales', type: 'PUBLICO', ben: 150 }, { name: 'Talleres formación', type: 'FORMACIÓN', ben: 25 }, { name: 'Exposición FNU', type: 'CIRCULACIÓN', ben: 200 }] },
            { network: 'Red Intercultural Juvenil', name: 'La Tigra', city: 'Piedecuesta', lat: 6.988, lng: -73.048, contribution: 70000000, events: [{ name: 'Talleres artísticos', type: 'FORMACIÓN', ben: 25 }, { name: 'Festival La Tigra', type: 'CIRCULACIÓN', ben: 1500 }, { name: 'Muralismo y Mapping', type: 'PUBLICO', ben: 300 }] },
            { network: 'Red Intercultural Juvenil', name: 'KOMBILESA MI', city: 'San Basilio', lat: 10.105, lng: -75.198, contribution: 40000000, events: [{ name: 'Talleres música/lengua', type: 'FORMACIÓN', ben: 40 }] },
            { network: 'Red Intercultural Juvenil', name: 'YUKUTA SONIDO NATIVO', city: 'Inírida', lat: 3.865, lng: -67.923, contribution: 35000000, events: [{ name: 'Talleres Música', type: 'FORMACIÓN', ben: 35 }, { name: 'Festival King Yakaré', type: 'CIRCULACIÓN', ben: 450 }] },
            { network: 'Red Intercultural Juvenil', name: 'Vida-Paz', city: 'San José del Guaviare', lat: 2.572, lng: -72.645, contribution: 100000000, events: [{ name: 'Talleres Bioculturales', type: 'FORMACIÓN', ben: 100 }, { name: 'Evento de cierre', type: 'CIRCULACIÓN', ben: 400 }] },
            { network: 'Red Intercultural Juvenil', name: 'ARTE SHEMBASENG', city: 'Sibundoy', lat: 1.205, lng: -76.920, contribution: 40000000, events: [{ name: 'Charlas y Talleres', type: 'FORMACIÓN', ben: 25 }, { name: 'Evento muralístico', type: 'CIRCULACIÓN', ben: 150 }] },
            { network: 'Red Intercultural Juvenil', name: 'D Three Studio', city: 'Bogotá', lat: 4.711, lng: -74.072, contribution: 20000000, events: [{ name: 'Cypher y Funciones', type: 'CIRCULACIÓN', ben: 250 }, { name: 'Festival Batallas', type: 'CIRCULACIÓN', ben: 400 }] },
            { network: 'Red Intercultural Juvenil', name: 'MANGLARIA DIVERSA', city: 'Tumaco', lat: 1.805, lng: -78.764, contribution: 40000000, events: [{ name: 'Talleres Danza/Música', type: 'FORMACIÓN', ben: 45 }, { name: 'Encuentro socialización', type: 'PUBLICO', ben: 250 }] },
            { network: 'Red Intercultural Juvenil', name: 'RITMO EXTREMO', city: 'Apartadó', lat: 7.883, lng: -76.633, contribution: 30000000, events: [{ name: 'Laboratorios Danza', type: 'FORMACIÓN', ben: 120 }, { name: 'Circulación intercambio', type: 'CIRCULACIÓN', ben: 200 }] },
            { network: 'Red Intercultural Juvenil', name: 'FUNDACIÓN MUSIQULTURA - Escuela la Esfera', city: 'San Andrés', lat: 12.584, lng: -81.700, contribution: 60000000, events: [{ name: 'Formación orquestal', type: 'FORMACIÓN', ben: 40 }, { name: 'Lanzamiento Video', type: 'CIRCULACIÓN', ben: 50 }] },
            { network: 'Red Intercultural Juvenil', name: 'Arreglando el País', city: 'Pitalito', lat: 1.853, lng: -76.048, contribution: 30000000, events: [{ name: 'Diplomado Vientos', type: 'FORMACIÓN', ben: 30 }, { name: 'Evento muestra final', type: 'CIRCULACIÓN', ben: 300 }] },
            { network: 'Red Intercultural Juvenil', name: 'KHUYAY', city: 'Pereira', lat: 4.813, lng: -75.694, contribution: 30000000, events: [{ name: 'Festival Pereira', type: 'CIRCULACIÓN', ben: 600 }, { name: 'Ciclo formación', type: 'FORMACIÓN', ben: 20 }] },
            { network: 'Red Intercultural Juvenil', name: 'PACIFICA CULTURAL', city: 'Cali', lat: 3.451, lng: -76.532, contribution: 90000000, events: [{ name: 'Laboratorios Creación', type: 'FORMACIÓN', ben: 40 }, { name: 'Conciertos Cacerolazo', type: 'CIRCULACIÓN', ben: 350 }] },
            { network: 'Red Intercultural Juvenil', name: 'CALINA CUMBAY', city: 'Armero Guayabal', lat: 5.030, lng: -74.883, contribution: 30000000, events: [{ name: 'Talleres Danza/Circo', type: 'FORMACIÓN', ben: 50 }, { name: 'Lagunilla Bio Fest', type: 'CIRCULACIÓN', ben: 600 }, { name: 'Turismo y Gastronomía', type: 'PUBLICO', ben: 80 }] },
            { network: 'Red Intercultural Juvenil', name: 'LINDEROS DE PAZ', city: 'Bogotá', lat: 4.550, lng: -74.150, contribution: 45000000, events: [{ name: 'Sesiones Formativas', type: 'FORMACIÓN', ben: 25 }, { name: 'Muestra Artística', type: 'CIRCULACIÓN', ben: 150 }] },
            { network: 'Red Intercultural Juvenil', name: 'PARCHEMOS POR YACOPI', city: 'Yacopí', lat: 5.456, lng: -74.348, contribution: 40000000, events: [{ name: 'Laboratorio Muralismo', type: 'FORMACIÓN', ben: 25 }, { name: 'Sancocho Master', type: 'PUBLICO', ben: 500 }] },
            { network: 'Red Intercultural Juvenil', name: 'ATICOYA', city: 'Puerto Nariño', lat: -3.774, lng: -70.383, contribution: 14579439, events: [{ name: 'Talleres y Ritual', type: 'FORMACIÓN', ben: 40 }, { name: 'Evento de cierre', type: 'CIRCULACIÓN', ben: 300 }] },
            { network: 'Red Intercultural Juvenil', name: 'CORPORACIÓN ARTÍSTICA Y CULTURAL HUELLAS DE MI TIERRA', city: 'Cúcuta', lat: 7.893, lng: -72.507, contribution: 80000000, events: [{ name: 'Bari Rock Fest', type: 'CIRCULACIÓN', ben: 1000 }] },
            { network: 'Red Intercultural Juvenil', name: 'Fundación AMAHIA', city: 'Sogamoso', lat: 5.714, lng: -72.933, contribution: 30000000, events: [{ name: 'Talleres rurales', type: 'FORMACIÓN', ben: 30 }, { name: 'Fiesta Infancias', type: 'PUBLICO', ben: 80 }] },
            { network: 'Red Intercultural Juvenil', name: 'Corporación Elements', city: 'Medellín', lat: 6.244, lng: -75.574, contribution: 0, events: [{ name: 'Crew Peligrosos', type: 'CIRCULACIÓN' }] },
            { network: 'Red Intercultural Juvenil', name: 'Danzantes Janshan', city: 'Sibundoy', lat: 1.205, lng: -76.920, contribution: 45000000, events: [{ name: 'Talleres Evocar', type: 'FORMACIÓN', ben: 30 }, { name: 'Laboratorios poética', type: 'FORMACIÓN', ben: 20 }, { name: 'Evento de cierre', type: 'CIRCULACIÓN', ben: 400 }, { name: 'Feria economía', type: 'PUBLICO', ben: 300 }] },
            { network: 'Red Intercultural Juvenil', name: 'Corporación Cultural Barule', city: 'Cali', lat: 3.451, lng: -76.532, contribution: 50000000, events: [{ name: 'Talleres formación', type: 'FORMACIÓN', ben: 50 }, { name: 'Evento cultural', type: 'CIRCULACIÓN', ben: 200 }] },

            // --- RED HIP HOP ---
            { network: 'Red Hip Hop', name: '5TA CON 5TA CREW', city: 'Cúcuta', lat: 7.907, lng: -72.504, contribution: 28450000, events: [{ name: 'Proceso Pedagógico', type: 'FORMACIÓN', ben: 1000 }, { name: 'Cierre Proceso', type: 'CIRCULACIÓN' }, { name: 'Festival 5ta con 5ta', type: 'PUBLICO' }] },
            { network: 'Red Hip Hop', name: 'SURPRISE CITY', city: 'Pasto', lat: 1.213, lng: -77.281, contribution: 28450000, events: [{ name: 'Talleres Jamondino', type: 'FORMACIÓN', ben: 3000 }, { name: 'Festival Hip Hop Paz', type: 'PUBLICO' }] },
            { network: 'Red Hip Hop', name: 'HIP HOP PEÑA', city: 'Cali', lat: 3.451, lng: -76.532, contribution: 28450000, events: [{ name: 'Encuentros Formativos', type: 'FORMACIÓN', ben: 100 }, { name: 'Cali Ciudad Hip Hop', type: 'PUBLICO', ben: 2000 }] },
            { network: 'Red Hip Hop', name: 'PAZ Y TERRITORIO', city: 'Ibagué', lat: 4.438, lng: -75.232, contribution: 28450000, events: [{ name: 'Sesiones Formativas', type: 'FORMACIÓN', ben: 100 }, { name: 'Ibagué Hip Hop Fest', type: 'PUBLICO', ben: 2000 }] },
            { network: 'Red Hip Hop', name: 'CASA KOLACHO', city: 'Medellín', lat: 6.244, lng: -75.574, contribution: 28450000, events: [{ name: 'Manifiesto Fest', type: 'PUBLICO', ben: 4000 }, { name: 'Talleres Hip Hop Vida', type: 'FORMACIÓN', ben: 80 }] },
            { network: 'Red Hip Hop', name: 'RAPJUDESCO', city: 'Bogotá', lat: 4.711, lng: -74.072, contribution: 28450000, events: [{ name: 'Rap Literario', type: 'FORMACIÓN', ben: 30 }, { name: 'Producción Musical', type: 'FORMACIÓN', ben: 30 }, { name: 'Académico Festival', type: 'FORMACIÓN', ben: 100 }, { name: 'Festival Rap Judesco', type: 'PUBLICO', ben: 4000 }] },
            { network: 'Red Hip Hop', name: 'EL CIRCULO HIP HOP', city: 'Bogotá', lat: 4.711, lng: -74.072, contribution: 28450000, events: [{ name: 'Talleres Formación', type: 'FORMACIÓN', ben: 100 }, { name: 'Festival Lil Concep', type: 'PUBLICO', ben: 1000 }] },
            { network: 'Red Hip Hop', name: 'TURA HIP HOP', city: 'Buenaventura', lat: 3.877, lng: -77.025, contribution: 28450000, events: [{ name: 'Composición Lírica', type: 'FORMACIÓN', ben: 100 }] },
            { network: 'Red Hip Hop', name: 'CASA DEL BARDO', city: 'Medellín', lat: 6.244, lng: -75.574, contribution: 28450000, events: [{ name: 'Proceso Formación', type: 'FORMACIÓN', ben: 30 }, { name: 'Circulación Artistas', type: 'CIRCULACIÓN', ben: 100 }] },
            { network: 'Red Hip Hop', name: 'MONTAÑA RECORDS', city: 'Ocaña', lat: 8.237, lng: -73.355, contribution: 28450000, events: [{ name: 'Talleres y Sistematización', type: 'FORMACIÓN', ben: 100 }, { name: 'Hip Hop Campesino', type: 'PUBLICO', ben: 1000 }] },
            { network: 'Red Hip Hop', name: 'HIP HOP POR LA VIDA', city: 'Manizales', lat: 5.068, lng: -75.517, contribution: 28450000, events: [{ name: 'Talleres Creación', type: 'FORMACIÓN', ben: 100 }, { name: 'Festival Hip Hop', type: 'PUBLICO', ben: 2000 }] },
            { network: 'Red Hip Hop', name: 'EXPRESION TEJIDA', city: 'Cartagena', lat: 10.393, lng: -75.482, contribution: 28450000, events: [{ name: 'Formación Integral', type: 'FORMACIÓN', ben: 100 }, { name: 'Encuentro Nacional', type: 'PUBLICO', ben: 500 }] },
            { network: 'Red Hip Hop', name: 'HIP HOP IPIALES', city: 'Ipiales', lat: 0.828, lng: -77.641, contribution: 28450000, events: [{ name: 'Formación Hip Hop', type: 'FORMACIÓN', ben: 100 }, { name: 'Festival Binacional', type: 'PUBLICO', ben: 2000 }] },
            { network: 'Red Hip Hop', name: 'CASA BEAT', city: 'Cali', lat: 3.451, lng: -76.532, contribution: 28450000, events: [{ name: 'Talleres Formación', type: 'FORMACIÓN', ben: 100 }, { name: 'Festival Cali Beat', type: 'PUBLICO', ben: 3000 }] },
            { network: 'Red Hip Hop', name: 'CASITA DE COLORES', city: 'San Juan de Arama', lat: 3.370, lng: -73.870, contribution: 28450000, events: [{ name: 'Experiencias Pedagógicas', type: 'FORMACIÓN', ben: 500 }, { name: 'Festival Georgina Ortiz', type: 'PUBLICO', ben: 1000 }] },
            { network: 'Red Hip Hop', name: 'POR NUESTRA TIERRA', city: 'Sogamoso', lat: 5.714, lng: -72.933, contribution: 28450000, events: [{ name: 'Fortalecimiento Espacios', type: 'FORMACIÓN', ben: 200 }, { name: 'Festival COMPAS', type: 'PUBLICO', ben: 2000 }] },

             // --- ORGANIZACIONES EMERGENTES ---
            { network: 'Organizaciones Emergentes', name: 'Cuna de Acordeones', city: 'Villanueva', lat: 10.609, lng: -72.981, contribution: 100000000, events: [{ name: 'Concurso Talentos', type: 'CIRCULACIÓN', ben: 4000 }] },
            { network: 'Organizaciones Emergentes', name: 'La Nana', city: 'Fundación', lat: 10.521, lng: -74.186, contribution: 25000000, events: [{ name: 'Festival Teatro', type: 'CIRCULACIÓN', ben: 1000 }, { name: 'Talleres Teatro', type: 'FORMACIÓN', ben: 200 }] },
            { network: 'Organizaciones Emergentes', name: 'ASOPAMURIMAJSA', city: 'San José del Guaviare', lat: 2.573, lng: -72.641, contribution: 50000000, events: [{ name: 'Foros Saberes', type: 'FORMACIÓN', ben: 1000 }, { name: 'Muestra Cooperativa', type: 'FORMACIÓN', ben: 100 }, { name: 'Muestras Artísticas', type: 'CIRCULACIÓN', ben: 1000 }] },
            { network: 'Organizaciones Emergentes', name: 'Cine Verde', city: 'Barichara', lat: 6.636, lng: -73.223, contribution: 120000000, events: [{ name: 'Proyecciones Parque', type: 'CIRCULACIÓN', ben: 2500 }, { name: 'Campecine', type: 'CIRCULACIÓN', ben: 800 }, { name: 'Agenda Académica', type: 'FORMACIÓN', ben: 400 }] },
            { network: 'Organizaciones Emergentes', name: 'Sin Fronteras', city: 'Buga', lat: 3.900, lng: -76.298, contribution: 140000000, events: [{ name: 'Espacios Formativos', type: 'FORMACIÓN', ben: 500 }, { name: 'Conciertos', type: 'CIRCULACIÓN', ben: 1800 }] },
            { network: 'Organizaciones Emergentes', name: 'CORPACOROS', city: 'Cali', lat: 3.440, lng: -76.532, contribution: 50000000, events: [{ name: 'Encuentro Coral', type: 'CIRCULACIÓN', ben: 3000 }, { name: 'Fortalecimiento Pedagógico', type: 'FORMACIÓN', ben: 250 }] },
            { network: 'Organizaciones Emergentes', name: 'ASOMAUCOWOT', city: 'San José del Guaviare', lat: 2.573, lng: -72.641, contribution: 50000000, events: [{ name: 'Encuentro Interétnico', type: 'FORMACIÓN', ben: 750 }, { name: 'Transmisión Saberes', type: 'FORMACIÓN', ben: 100 }] },
            { network: 'Organizaciones Emergentes', name: 'CORARTE', city: 'Cali', lat: 3.451, lng: -76.532, contribution: 50000000, events: [{ name: 'Armonías de Buga', type: 'CIRCULACIÓN', ben: 1000 }, { name: 'Espacios Formativos', type: 'FORMACIÓN', ben: 300 }] },
            { network: 'Organizaciones Emergentes', name: 'Un Mar de Voces', city: 'Puerto Colombia', lat: 10.988, lng: -74.958, contribution: 45000000, events: [{ name: 'Concierto Clausura', type: 'CIRCULACIÓN', ben: 780 }, { name: 'Espacios Formativos', type: 'FORMACIÓN', ben: 113 }] },
            { network: 'Organizaciones Emergentes', name: 'La Concepción', city: 'San Juan de Urabá', lat: 8.761, lng: -76.529, contribution: 50000000, events: [{ name: 'Festival Sextetos', type: 'CIRCULACIÓN', ben: 1000 }, { name: 'Espacios Formativos', type: 'FORMACIÓN', ben: 130 }] },
            { network: 'Organizaciones Emergentes', name: 'Coral Santa María', city: 'Manizales', lat: 5.068, lng: -75.517, contribution: 10000000, events: [{ name: 'Coro a la Plaza', type: 'CIRCULACIÓN', ben: 300 }, { name: 'Espacios Formativos', type: 'FORMACIÓN', ben: 245 }] },
            { network: 'Organizaciones Emergentes', name: 'Arte y Parte', city: 'Cali', lat: 3.451, lng: -76.532, contribution: 125000000, events: [{ name: 'Socializaciones', type: 'CIRCULACIÓN', ben: 1500 }, { name: 'Espacios Formativos', type: 'FORMACIÓN', ben: 350 }] },
            { network: 'Organizaciones Emergentes', name: 'Afroresilientes', city: 'Santa Marta', lat: 11.240, lng: -74.211, contribution: 25000000, events: [{ name: 'Espacios Formativos', type: 'FORMACIÓN', ben: 40 }, { name: 'Muestras', type: 'CIRCULACIÓN', ben: 150 }] },
            { network: 'Organizaciones Emergentes', name: 'Prometeo', city: 'Medellín', lat: 6.244, lng: -75.581, contribution: 150000000, events: [{ name: 'Festival Poesía', type: 'CIRCULACIÓN', ben: 3000 }, { name: 'Espacios Formativos', type: 'FORMACIÓN', ben: 1420 }] },
            { network: 'Organizaciones Emergentes', name: 'Banda Gutiérrez', city: 'Gutiérrez', lat: 4.253, lng: -74.000, contribution: 20000000, events: [{ name: 'Festival Internacional', type: 'CIRCULACIÓN', ben: 1200 }] },
            { network: 'Organizaciones Emergentes', name: 'Unidos Desarrollo', city: 'San Pelayo', lat: 8.957, lng: -75.847, contribution: 20000000, events: [{ name: 'Encuentro Soy Pelayero', type: 'CIRCULACIÓN', ben: 600 }] },
            { network: 'Organizaciones Emergentes', name: 'Identidad Despierta', city: 'Riohacha', lat: 11.544, lng: -72.907, contribution: 28400000, events: [{ name: 'Transformarte', type: 'CIRCULACIÓN', ben: 700 }] },
            { network: 'Organizaciones Emergentes', name: 'Paz y Reconciliación', city: 'Aracataca', lat: 10.593, lng: -74.189, contribution: 200000000, events: [{ name: 'Festival Macondo', type: 'CIRCULACIÓN', ben: 600 }] },
            { network: 'Organizaciones Emergentes', name: 'Dramático Magdalena', city: 'Santa Marta', lat: 11.240, lng: -74.211, contribution: 200000000, events: [{ name: 'Proceso Teatral', type: 'FORMACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Carmen Mantilla', city: 'El Plato', lat: 10.230, lng: -74.783, contribution: 30000000, events: [{ name: 'Actividades Musicales', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Cabildos Ipiales', city: 'Ipiales', lat: 0.828, lng: -77.641, contribution: 80000000, events: [{ name: 'Encuentro Musical', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'L&M', city: 'Paipa', lat: 5.784, lng: -73.117, contribution: 70000000, events: [{ name: 'Danza', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Marcashi Group', city: 'Bogotá', lat: 4.711, lng: -74.072, contribution: 80000000, events: [{ name: 'Música', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Tierra Pazífica', city: 'Cali', lat: 3.451, lng: -76.532, contribution: 200000000, events: [{ name: 'Música y Formación', type: 'FORMACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Cultura Nativa', city: 'Bogotá', lat: 4.711, lng: -74.072, contribution: 80000000, events: [{ name: 'Teatro', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'CORPOULRIKA', city: 'Bogotá', lat: 4.711, lng: -74.072, contribution: 150000000, events: [{ name: 'Literatura', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Transformación Social', city: 'Barrancabermeja', lat: 7.065, lng: -73.854, contribution: 40000000, events: [{ name: 'Danza', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Esquina del Barrio', city: 'Ibagué', lat: 4.439, lng: -75.232, contribution: 30000000, events: [{ name: 'Música y Danza', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Víctimas Santiago', city: 'Ataco', lat: 3.581, lng: -75.390, contribution: 50000000, events: [{ name: 'Actividad Cultural', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Centro Periferia', city: 'Bogotá', lat: 4.711, lng: -74.072, contribution: 128800650, events: [{ name: 'Danza', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Centro de Altos Estudios en Tradición Contemporánea', city: 'Bogotá', lat: 4.711, lng: -74.072, contribution: 0, events: [{ name: 'Actividades culturales', type: 'FORMACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Asociación de Víctimas Núcleo Santiago Pérez', city: 'Ataco', lat: 3.581, lng: -75.390, contribution: 0, events: [{ name: 'Actividades culturales', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'ONG de Liderazgo Juvenil y Participativo', city: 'Armero', lat: 5.030, lng: -74.883, contribution: 0, events: [{ name: 'Actividades culturales', type: 'FORMACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Corporación Kanda Docarí', city: 'Ocaña', lat: 8.237, lng: -73.355, contribution: 0, events: [{ name: 'Actividades culturales', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Corporación Elemental Ecosistema Cultural', city: 'San Vicente de Chucurí', lat: 6.881, lng: -73.410, contribution: 0, events: [{ name: 'Actividades culturales', type: 'FORMACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Asociación de Artistas Cluster Nómadas Amazonas', city: 'Leticia', lat: -4.215, lng: -69.941, contribution: 0, events: [{ name: 'Actividades culturales', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Corporación Artística Ecos Pacífico', city: 'Tumaco', lat: 1.805, lng: -78.764, contribution: 0, events: [{ name: 'Actividades culturales', type: 'CIRCULACIÓN' }] },
            { network: 'Organizaciones Emergentes', name: 'Asociación Red de Defensores y Defensoras de Derechos Humanos', city: 'Bogotá', lat: 4.711, lng: -74.072, contribution: 0, events: [{ name: 'Actividades culturales', type: 'FORMACIÓN' }] },

            // --- CIRCULACIÓN NACIONAL E INTERNACIONAL ---
            { network: 'Circulación Nacional e Internacional', name: 'FUNDACION MUJERES INDEPENDIENTES', city: 'Gutiérrez', lat: 4.253, lng: -74.000, contribution: 20000000, events: [{ name: 'Festival Internacional Música', type: 'CIRCULACIÓN' }] },
            { network: 'Circulación Nacional e Internacional', name: 'MONICA ÁVILA BALLESTEROS', city: 'Tumaco', lat: 1.805, lng: -78.764, contribution: 12327319, events: [{ name: 'Grupo Coral Perlas', type: 'CIRCULACIÓN' }] },
            { network: 'Circulación Nacional e Internacional', name: 'CORPORACION L&M (Gira)', city: 'Paipa', lat: 5.783, lng: -73.117, contribution: 70000000, events: [{ name: 'Festival Folclore Bulgaria', type: 'CIRCULACIÓN' }] },
            { network: 'Circulación Nacional e Internacional', name: 'PAULA ANDREA ARELLANO', city: 'Colombia', lat: 4.570, lng: -74.297, contribution: 10260632, events: [{ name: 'Circulación Ballet', type: 'CIRCULACIÓN' }] },
            { network: 'Circulación Nacional e Internacional', name: 'TEATRO DANZA PIES DEL SOL', city: 'Amazonas', lat: -1.444, lng: -71.931, contribution: 10256410, events: [{ name: 'Evento Pueblos Amazónicos', type: 'CIRCULACIÓN' }] },
            { network: 'Circulación Nacional e Internacional', name: 'CINE SIN FRONTERAS', city: 'Tijuana', lat: 32.514, lng: -117.038, contribution: 33743000, events: [{ name: 'Participación Tijuana', type: 'CIRCULACIÓN' }] },
            { network: 'Circulación Nacional e Internacional', name: 'CONGRESO NACIONAL DE MUSICA', city: 'Ibagué', lat: 4.438, lng: -75.232, contribution: 33582000, events: [{ name: 'Congreso Nacional', type: 'CIRCULACIÓN' }] },
            { network: 'Circulación Nacional e Internacional', name: 'GRUPO DE MAR Y RIO', city: 'Brasil', lat: -10.335, lng: -53.197, contribution: 5690000, events: [{ name: 'Circulación Brasil', type: 'CIRCULACIÓN' }] },
            { network: 'Circulación Nacional e Internacional', name: 'JOHANA CARVAJAL', city: 'Londres', lat: 51.507, lng: -0.127, contribution: 8452426, events: [{ name: 'Participación Londres', type: 'CIRCULACIÓN' }] },
            { network: 'Circulación Nacional e Internacional', name: 'LEANY MISLENA LAULATE', city: 'Palenque', lat: 10.105, lng: -75.198, contribution: 4000000, events: [{ name: 'Intercambio Cultural', type: 'CIRCULACIÓN' }] },

            // --- CULTURA FESTIVA DEL TERRITORIO ---
            { network: 'Cultura Festiva del Territorio', name: 'PROMETEO (Fest)', city: 'Medellín', lat: 6.244, lng: -75.574, contribution: 150000000, events: [{ name: 'Festival Poesía', type: 'PUBLICO' }] },
            { network: 'Cultura Festiva del Territorio', name: 'DECUPLUM (Fest)', city: 'Valledupar', lat: 10.463, lng: -73.253, contribution: 50000000, events: [{ name: 'Festival EVAFE', type: 'CIRCULACIÓN' }] },
            { network: 'Cultura Festiva del Territorio', name: 'COLOMBIA BAILA', city: 'Florencia', lat: 1.614, lng: -75.606, contribution: 15000000, events: [{ name: 'Festival Colombia Baila', type: 'CIRCULACIÓN' }] },
            { network: 'Cultura Festiva del Territorio', name: 'LA NANA (Fest)', city: 'Fundación', lat: 10.520, lng: -74.184, contribution: 25000000, events: [{ name: 'Festival Teatro', type: 'CIRCULACIÓN' }] },
            { network: 'Cultura Festiva del Territorio', name: 'CABILDOS IPIALES (Bandas)', city: 'Samaniego', lat: 1.336, lng: -77.602, contribution: 80000000, events: [{ name: 'Concurso Bandas', type: 'CIRCULACIÓN' }] },
            { network: 'Cultura Festiva del Territorio', name: 'DESARROLLO CORAL BUGA', city: 'Buga', lat: 3.900, lng: -76.300, contribution: 50000000, events: [{ name: 'Encuentro Coral', type: 'CIRCULACIÓN' }] },
            { network: 'Cultura Festiva del Territorio', name: 'CUNA DE ACORDEONES (Fest)', city: 'Villanueva', lat: 10.615, lng: -72.975, contribution: 100000000, events: [{ name: 'Festival Cuna Acordeones', type: 'CIRCULACIÓN' }] },
            { network: 'Cultura Festiva del Territorio', name: 'LA CONCEPCION (Sexteto)', city: 'San Pelayo', lat: 8.957, lng: -75.829, contribution: 50000000, events: [{ name: 'Encuentro Sexteto', type: 'CIRCULACIÓN' }] },
            { network: 'Cultura Festiva del Territorio', name: 'CINE VERDE (Fest)', city: 'Barichara', lat: 6.638, lng: -73.224, contribution: 120000000, events: [{ name: 'Festival Cine Verde', type: 'PUBLICO' }] },
            { network: 'Cultura Festiva del Territorio', name: 'LA ESKINA DEL BARRIO (Fest)', city: 'Ibagué', lat: 4.438, lng: -75.232, contribution: 30000000, events: [{ name: 'Festival Hip Hop', type: 'CIRCULACIÓN' }] },

            // --- NARRATIVAS ---
            { network: 'Narrativas Artísticas y Bioculturales', name: 'PAZ Y RECONCILIACION-PARES', city: 'Aracataca', lat: 10.590, lng: -74.184, contribution: 200000000, events: [{ name: 'Festival Macondo', type: 'PUBLICO' }] },

            // --- AGREGADOS RECIENTES ---
            { network: 'Cultura Festiva del Territorio', name: 'CORPORACIÓN DINASTÍA NEGRA', city: 'Apartadó', lat: 7.883, lng: -76.633, contribution: 40000000, events: [{ name: 'Festival de Danza de Urabá', type: 'CIRCULACIÓN' }] },
            { network: 'Circulación Nacional e Internacional', name: 'Lanzamiento Istmina', city: 'Istmina', lat: 5.160, lng: -76.683, contribution: 3200000, events: [{ name: 'Lanzamiento Artes para la Paz', type: 'CIRCULACIÓN' }] }
        ];

        // Conteos y listados territoriales (según matriz de Regionalización de inversión 04-12-2025)
        // Ajustes: Bogotá D.C. se integra a Cundinamarca (no cuenta como departamento)
        // Arauca incluido por organizaciones de Red de Mujeres
        const regionalizationImpactCounts = { municipalities: 112, departments: 30 };

        const regionalizationImpactLists = {
            departments: ["AMAZONAS", "ANTIOQUIA", "ARAUCA", "ARCHIPIÉLAGO DE SAN ANDRÉS, PROVIDENCIA Y SANTA CATALINA", "ATLÁNTICO", "BOLÍVAR", "BOYACÁ", "CALDAS", "CAQUETÁ", "CAUCA", "CESAR", "CHOCÓ", "CUNDINAMARCA", "CÓRDOBA", "GUAINÍA", "GUAVIARE", "HUILA", "LA GUAJIRA", "MAGDALENA", "META", "NARIÑO", "NORTE DE SANTANDER", "PUTUMAYO", "QUINDÍO", "RISARALDA", "SANTANDER", "SUCRE", "TOLIMA", "VALLE DEL CAUCA", "VICHADA"],
            municipalitiesAndCities: ["ARACATACA — MAGDALENA", "ARMENIA — QUINDÍO", "ARMERO — TOLIMA", "BAGADÓ — CHOCÓ", "BARICHARA — SANTANDER", "BARRANCABERMEJA — SANTANDER", "BARRANQUILLA — ATLÁNTICO", "BELLO — ANTIOQUIA", "BOGOTÁ, D.C. — CUNDINAMARCA", "BUCARAMANGA — SANTANDER", "BUENAVENTURA — VALLE DEL CAUCA", "CAJICÁ — CUNDINAMARCA", "CALDAS — ANTIOQUIA", "CALOTO — CAUCA", "CAREPA — ANTIOQUIA", "CARMEN DEL DARIÉN — CHOCÓ", "CARTAGENA DE INDIAS — BOLÍVAR", "CERETÉ — CÓRDOBA", "CHIGORODÓ — ANTIOQUIA", "CHIRIGUANÁ — CESAR", "CHÍA — CUNDINAMARCA", "CONDOTO — CHOCÓ", "COROZAL — SUCRE", "DABEIBA — ANTIOQUIA", "DUITAMA — BOYACÁ", "EL BANCO — MAGDALENA", "EL RETORNO — GUAVIARE", "ENVIGADO — ANTIOQUIA", "FLORIDA — VALLE DEL CAUCA", "FUNDACIÓN — MAGDALENA", "FUNZA — CUNDINAMARCA", "GALAPA — ATLÁNTICO", "GIRARDOTA — ANTIOQUIA", "GUADALAJARA DE BUGA — VALLE DEL CAUCA", "GUTIÉRREZ — CUNDINAMARCA", "GÉNOVA — QUINDÍO", "IBAGUÉ — TOLIMA", "INÍRIDA — GUAINÍA", "IPIALES — NARIÑO", "ISTMINA — CHOCÓ", "JAMUNDÍ — VALLE DEL CAUCA", "LA BELLEZA — SANTANDER", "LA MONTAÑITA — CAQUETÁ", "LETICIA — AMAZONAS", "LURUACO — ATLÁNTICO", "LÉRIDA — TOLIMA", "MAHATES — BOLÍVAR", "MAICAO — LA GUAJIRA", "MANIZALES — CALDAS", "MEDELLÍN — ANTIOQUIA", "MEDIO BAUDÓ — CHOCÓ", "MOCOA — PUTUMAYO", "MONTELÍBANO — CÓRDOBA", "MONTERÍA — CÓRDOBA", "NECOCLÍ — ANTIOQUIA", "OCAÑA — NORTE DE SANTANDER", "PAIPA — BOYACÁ", "PASTO — NARIÑO", "PEREIRA — RISARALDA", "PEÑOL — ANTIOQUIA", "PIEDECUESTA — SANTANDER", "PINCHOTE — SANTANDER", "PITALITO — HUILA", "POPAYÁN — CAUCA", "PROVIDENCIA — ARCHIPIÉLAGO DE SAN ANDRÉS, PROVIDENCIA Y SANTA CATALINA", "PUEBLO BELLO — CESAR", "PUERTO ASÍS — PUTUMAYO", "PUERTO CARREÑO — VICHADA", "PUERTO COLOMBIA — ATLÁNTICO", "PUERTO LÓPEZ — META", "PUERTO NARIÑO — AMAZONAS", "QUIBDÓ — CHOCÓ", "RIOHACHA — LA GUAJIRA", "RIOSUCIO — CALDAS", "RIVERA — HUILA", "RÍO IRÓ — CHOCÓ", "SABANETA — ANTIOQUIA", "SAMANIEGO — NARIÑO", "SAN ANDRÉS DE TUMACO — NARIÑO", "SAN ANDRÉS — ARCHIPIÉLAGO DE SAN ANDRÉS, PROVIDENCIA Y SANTA CATALINA", "SAN CARLOS — ANTIOQUIA", "SAN JACINTO — BOLÍVAR", "SAN JOSÉ DE CÚCUTA — NORTE DE SANTANDER", "SAN JOSÉ DEL GUAVIARE — GUAVIARE", "SAN JUAN DE ARAMA — META", "SAN JUAN DE URABÁ — ANTIOQUIA", "SAN PELAYO — CÓRDOBA", "SAN VICENTE DE CHUCURÍ — SANTANDER", "SANTA MARTA — MAGDALENA", "SANTIAGO DE CALI — VALLE DEL CAUCA", "SEVILLA — VALLE DEL CAUCA", "SIBUNDOY — PUTUMAYO", "SOACHA — CUNDINAMARCA", "SOGAMOSO — BOYACÁ", "SONSÓN — ANTIOQUIA", "SOPÓ — CUNDINAMARCA", "SUESCA — CUNDINAMARCA", "TOCANCIPÁ — CUNDINAMARCA", "TULUÁ — VALLE DEL CAUCA", "TUNJA — BOYACÁ", "TURBACO — BOLÍVAR", "VALLEDUPAR — CESAR", "VILLA DE LEYVA — BOYACÁ", "VILLA DEL ROSARIO — NORTE DE SANTANDER", "VILLANUEVA — LA GUAJIRA", "VILLANUEVA — SANTANDER", "VILLAPINZÓN — CUNDINAMARCA", "VILLAVICENCIO — META", "VISTAHERMOSA — META", "VITERBO — CALDAS", "YACOPÍ — CUNDINAMARCA", "YUMBO — VALLE DEL CAUCA"]
        };

        // Ajuste: la Red de Mujeres tiene 15 organizaciones (incluye Atrapa-sueños de Arauca)
        // Este override afecta el contador mostrado en el filtro; el mapa seguirá dependiendo de los puntos con lat/lng.
        const beneficiariesNetworkCountOverrides = {
            'Red de mujeres artistas y gestoras REMAG': 15
        };

        // Cobertura territorial mostrada (veredas/municipios/ciudades).
        // Nota: En este repo aún no está la matriz de beneficiarios; mientras tanto, se usa la lista de regionalización
        // como fallback (ubicada temporalmente en "municipios").
        const territorialCoverage = {
            municipalitiesAndCitiesCount: regionalizationImpactLists.municipalitiesAndCities.length,
            veredas: [],
            municipios: regionalizationImpactLists.municipalitiesAndCities,
            ciudades: []
        };

        // Total de inversión del convenio (cifra oficial)
        // Total del convenio (cifra fija solicitada)
        const totalAgreementInvestment = 7080670800;

        const formatCop = (value, decimals = 0) => {
            const n = Number.isFinite(value) ? value : Number(value || 0);
            return '$' + n.toLocaleString('es-CO', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals,
            });
        };

        const normalizeKey = (value) => (value || '').toString().trim().toLowerCase();

        const cityToDepartment = {
            // Para conteos departamentales del informe, Bogotá se integra a Cundinamarca (según solicitud)
            'bogotá': 'Cundinamarca',
            'bogota': 'Cundinamarca',
            'cali': 'Valle del Cauca',
            'medellín': 'Antioquia',
            'medellin': 'Antioquia',
            'san josé del guaviare': 'Guaviare',
            'san jose del guaviare': 'Guaviare',
            'ibagué': 'Tolima',
            'ibague': 'Tolima',
            'manizales': 'Caldas',
            'viterbo': 'Caldas',
            'chía': 'Cundinamarca',
            'chia': 'Cundinamarca',
            'tocancipá': 'Cundinamarca',
            'tocancipa': 'Cundinamarca',
            'sopó': 'Cundinamarca',
            'sopo': 'Cundinamarca',
            'suesca': 'Cundinamarca',
            'soacha': 'Cundinamarca',
            'yacopí': 'Cundinamarca',
            'yacopi': 'Cundinamarca',
            'gutiérrez': 'Cundinamarca',
            'gutierrez': 'Cundinamarca',
            'santa marta': 'Magdalena',
            'aracataca': 'Magdalena',
            'fundación': 'Magdalena',
            'fundacion': 'Magdalena',
            'el plato': 'Magdalena',
            'cúcuta': 'Norte de Santander',
            'cucuta': 'Norte de Santander',
            'ocaña': 'Norte de Santander',
            'ocana': 'Norte de Santander',
            'pasto': 'Nariño',
            'ipiales': 'Nariño',
            'samaniego': 'Nariño',
            'tumaco': 'Nariño',
            'quibdó': 'Chocó',
            'quibdo': 'Chocó',
            'istmina': 'Chocó',
            // Ciudades adicionales
            'arauca': 'Arauca',
            'leticia': 'Amazonas',
            'montería': 'Córdoba',
            'monteria': 'Córdoba',
            'cartagena': 'Bolívar',
            'san vicente de chucurí': 'Santander',
            'san vicente de chucuri': 'Santander',
            'armero': 'Tolima',
            'río iró': 'Chocó',
            'rio iró': 'Chocó',
            'rio iro': 'Chocó',
            'apartadó': 'Antioquia',
            'apartado': 'Antioquia',
            'mutatá': 'Antioquia',
            'mutata': 'Antioquia',
            'san juan de urabá': 'Antioquia',
            'san juan de uraba': 'Antioquia',
            'buenaventura': 'Valle del Cauca',
            'buga': 'Valle del Cauca',
            'cartagena': 'Bolívar',
            'san basilio': 'Bolívar',
            'palenque': 'Bolívar',
            'san pelayo': 'Córdoba',
            'corozal': 'Sucre',
            'riohacha': 'La Guajira',
            'villanueva': 'La Guajira',
            'valledupar': 'Cesar',
            'piedecuesta': 'Santander',
            'barichara': 'Santander',
            'barrancabermeja': 'Santander',
            'la belleza': 'Santander',
            'pitatilo': 'Huila',
            'pitalito': 'Huila',
            'pereira': 'Risaralda',
            'armenia': 'Quindío',
            'sibundoy': 'Putumayo',
            'san juan de arama': 'Meta',
            'armero guayabal': 'Tolima',
            'ataco': 'Tolima',
            'florencia': 'Caquetá',
            'luruaco': 'Atlántico',
            'puerto colombia': 'Atlántico',
            'san andrés': 'Archipiélago de San Andrés',
            'san andres': 'Archipiélago de San Andrés',
            'inírida': 'Guainía',
            'inirida': 'Guainía',
            'puerto nariño': 'Amazonas',
            'sogamoso': 'Boyacá',
            'paipa': 'Boyacá',
            'puerto carreño': 'Vichada',
            'puerto carreno': 'Vichada',
            'popayán': 'Cauca',
            'popayan': 'Cauca',
            'caloto': 'Cauca',
            'villavicencio': 'Meta',
            'puerto lópez': 'Meta',
            'puerto lopez': 'Meta',
            'cereté': 'Córdoba',
            'cerete': 'Córdoba',
            'montelíbano': 'Córdoba',
            'montelibano': 'Córdoba',
            'barranquilla': 'Atlántico',
            'galapa': 'Atlántico',
            'tunja': 'Boyacá',
            'duitama': 'Boyacá',
            'mocoa': 'Putumayo',
            'puerto asís': 'Putumayo',
            'puerto asis': 'Putumayo',
            'la montañita': 'Caquetá',
            'la montanita': 'Caquetá',
            'tijuana': 'Internacional',
            'londres': 'Internacional',
            'brasil': 'Internacional',
            'colombia': null,
            'amazonas': 'Amazonas'
        };

        const getDepartment = (org) => {
            const key = normalizeKey(org?.city);
            return cityToDepartment.hasOwnProperty(key) ? cityToDepartment[key] : null;
        };

        const isColombian = (org) => {
            const dept = getDepartment(org);
            if (dept && dept !== 'Internacional') return true;
            if (typeof org?.lat === 'number' && typeof org?.lng === 'number') {
                return org.lat >= -4.5 && org.lat <= 13.5 && org.lng >= -79.5 && org.lng <= -66.5;
            }
            return false;
        };

        const getMunicipalityName = (org) => {
            if (!isColombian(org)) return null;
            const city = (org?.city || '').toString().trim();
            if (!city) return null;
            const key = normalizeKey(city);
            if (key === 'colombia' || key === 'amazonas') return null;
            if (key === 'san basilio' || key === 'palenque') return 'San Basilio de Palenque';
            return city;
        };

        const hasFinePointer = () => {
            try {
                return window.matchMedia && window.matchMedia('(pointer: fine)').matches;
            } catch {
                return false;
            }
        };

        const isLandscapeLayout = () => window.innerWidth > window.innerHeight;
        const isWideLayout = () => window.innerWidth >= 768;

        const stripDiacritics = (value) =>
            (value || '')
                .toString()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');

        const canonicalizeName = (value) =>
            stripDiacritics(value)
                .toUpperCase()
                .replace(/[^A-Z0-9]+/g, ' ')
                .trim()
                .replace(/\s+/g, ' ');

        const parseDelimited = (text, delimiter = ',') => {
            const rows = [];
            let row = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                const next = text[i + 1];

                if (ch === '"') {
                    if (inQuotes && next === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                    continue;
                }

                if (!inQuotes && (ch === delimiter || ch === '\n' || ch === '\r')) {
                    if (ch === '\r' && next === '\n') i++;
                    row.push(current);
                    current = '';

                    if (ch === '\n' || ch === '\r') {
                        if (row.length > 1 || (row.length === 1 && row[0].trim() !== '')) rows.push(row);
                        row = [];
                    }
                    continue;
                }

                current += ch;
            }

            if (current.length || row.length) {
                row.push(current);
                if (row.length > 1 || (row.length === 1 && row[0].trim() !== '')) rows.push(row);
            }

            return rows;
        };

        const parseCsv = (text) => parseDelimited(text, ',');
        const parseSemicolonCsv = (text) => parseDelimited(text, ';');

        const toInt = (value) => {
            const raw = (value || '').toString().trim();
            if (!raw) return 0;
            const cleaned = raw.replace(/\./g, '').replace(/,/g, '').replace(/\s+/g, '');
            const n = Number(cleaned);
            return Number.isFinite(n) ? Math.trunc(n) : 0;
        };

        const uniqSorted = (items) => {
            const out = [...new Set((items || []).map((x) => (x || '').toString().trim()).filter(Boolean))];
            out.sort((a, b) => a.localeCompare(b, 'es'));
            return out;
        };

        const inferDepartmentForPlace = (place, deptHints = [], cityDeptMap = new Map()) => {
            const raw = (place || '').toString();
            const candidate = raw.includes('—')
                ? raw.split('—').slice(-1)[0].trim()
                : raw.replace(/^\s*(Vereda|Corregimiento)\s+/i, '').trim();
            const key = canonicalizeName(candidate);
            if (!key) return '';
            if (cityDeptMap.has(key)) return cityDeptMap.get(key);
            const deptFromCityMap = getDepartment({ city: candidate });
            if (deptFromCityMap && deptFromCityMap !== 'Internacional') return deptFromCityMap;
            const hints = (deptHints || []).map((d) => (d || '').toString().trim()).filter(Boolean);
            if (hints.length === 1) return hints[0];
            return '';
        };

        const parseDepartmentHints = (raw) => {
            const txt = (raw || '').toString();
            return uniqSorted(
                txt
                    .split(/,|;|\n|\//g)
                    .map((x) => x.trim())
                    .filter(Boolean)
            );
        };

        const parseTerritoriesFromFco = (raw) => {
            const txt = (raw || '').toString().trim();
            if (!txt) return { veredas: [], municipios: [], ciudades: [] };

            const segments = txt
                .split(/\n|\r|\u2022|\u00b7|;+/g)
                .map((s) => s.trim())
                .filter(Boolean);

            const veredas = [];
            const municipios = [];
            const ciudades = [];

            const pushFallbackItems = (seg) => {
                seg
                    .split(/,+/g)
                    .map((x) => x.trim())
                    .filter(Boolean)
                    .forEach((name) => municipios.push(name));
            };

            for (const seg of segments) {
                const low = stripDiacritics(seg).toLowerCase();

                const veredaMatch = seg.match(/(vereda|corregimiento|centro poblado)\s+([^,;\n]+)(?:,\s*(?:municipio|ciudad)\s*(?:de|del)?\s*([^,;\n]+))?/i);
                if (veredaMatch) {
                    let label = veredaMatch[1].toLowerCase();
                    if (label.includes('correg')) label = 'Corregimiento';
                    else if (label.includes('centro')) label = 'Centro Poblado';
                    else label = 'Vereda';
                    
                    const name = (veredaMatch[2] || '').trim();
                    const muni = (veredaMatch[3] || '').trim();
                    veredas.push(muni ? `${label} ${name} — ${muni}` : `${label} ${name}`);
                    continue;
                }

                const muniMatch = seg.match(/municipio\s*(?:de|del)?\s*([^,;\n]+)/i);
                if (muniMatch) {
                    municipios.push((muniMatch[1] || '').trim());
                    continue;
                }

                const cityMatch = seg.match(/ciudad\s*(?:de|del)?\s*([^,;\n]+)/i);
                if (cityMatch) {
                    ciudades.push((cityMatch[1] || '').trim());
                    continue;
                }

                if (low.includes('vereda') || low.includes('corregimiento') || low.includes('centro poblado') || low.includes('municipio') || low.includes('ciudad')) {
                    pushFallbackItems(seg);
                    continue;
                }

                // Sin etiqueta de categoría: se asume municipio/ciudad (se guarda en "municipios" como fallback).
                pushFallbackItems(seg);
            }

            return {
                veredas: uniqSorted(veredas),
                municipios: uniqSorted(municipios),
                ciudades: uniqSorted(ciudades)
            };
        };

        const buildAgendaCityDepartmentMap = async () => {
            try {
                if (window.location && window.location.protocol === 'file:') return new Map();
                const agendaPath = 'matrices/Agenda comisiones Equipio convenio 1022-2025.csv';
                const res = await fetch(encodeURI(agendaPath), { cache: 'no-store' });
                if (!res.ok) return new Map();
                const text = await res.text();
                const rows = parseSemicolonCsv(text);
                if (!rows.length) return new Map();
                const header = rows[0].map((h) => canonicalizeName(h));

                const idxCity = header.findIndex((h) => h.includes('municipio') || h.includes('ciudad'));
                const idxDept = header.findIndex((h) => h.includes('departamento'));
                if (idxCity < 0 || idxDept < 0) return new Map();

                const map = new Map();
                for (const r of rows.slice(1)) {
                    const city = (r[idxCity] || '').toString().trim();
                    const dept = (r[idxDept] || '').toString().trim();
                    if (!city || !dept) continue;
                    const key = canonicalizeName(city);
                    if (!key) continue;
                    if (!map.has(key)) map.set(key, dept);
                }
                return map;
            } catch (e) {
                console.warn('[BENEFICIARIOS] No se pudo construir mapa ciudad->departamento desde Agenda:', e);
                return new Map();
            }
        };

        const loadFcoBeneficiariesMatrix = async () => {
            const path = 'matrices/FCO INFORMACIÓN DE BENEFICIARIOS - CONVENIO 1022 (Respuestas) - Respuestas de formulario 1.csv';
            if (window.location && window.location.protocol === 'file:') {
                console.warn('[BENEFICIARIOS] No se puede hacer fetch() desde file://. Sirve el sitio con un servidor local para cargar:', path);
                return [];
            }
            const res = await fetch(encodeURI(path), { cache: 'no-store' });
            if (!res.ok) {
                console.warn('[BENEFICIARIOS] No se pudo cargar:', path, res.status);
                return [];
            }
            const text = await res.text();
            const rows = parseCsv(text);
            if (!rows.length) return [];
            const header = rows[0];
            const canon = header.map((h) => canonicalizeName(h));

            const idxOrg = canon.findIndex((h) => h.includes('nombre') && h.includes('organizacion'));
            const idxDept = canon.findIndex((h) => h.includes('departamento') && h.includes('llevaron'));
            const idxTerr = canon.findIndex((h) => h.includes('lista') && (h.includes('ciudad') || h.includes('municipio') || h.includes('vereda') || h.includes('corregimiento')));
            const idxNetwork = canon.findIndex((h) => h.includes('redes') || (h.includes('red') && h.includes('pertenece')));
            const idxDirect = canon.findIndex((h) => h.includes('beneficiarias') && h.includes('direct'));
            const idxIndirect = canon.findIndex((h) => h.includes('beneficiarias') && h.includes('indirect'));
            const idxPublic = canon.findIndex((h) => h.includes('publico') || h.includes('pUblico') || h.includes('espectador'));

            const records = [];
            for (const r of rows.slice(1)) {
                const org = (r[idxOrg] || '').toString().trim();
                if (!org) continue;
                records.push({
                    org,
                    network: (r[idxNetwork] || '').toString().trim(),
                    departments: parseDepartmentHints(r[idxDept] || ''),
                    territoriesRaw: (r[idxTerr] || '').toString().trim(),
                    direct: toInt(r[idxDirect]),
                    indirect: toInt(r[idxIndirect]),
                    public: toInt(r[idxPublic])
                });
            }
            return records;
        };

        const reportSemaforoComparison = async () => {
            try {
                if (window.location && window.location.protocol === 'file:') {
                    console.warn('[SEMAFORO] No se puede hacer fetch() desde file://. Sirve el sitio con un servidor local para comparar contra matrices/SEMÁFORO.csv');
                    return;
                }

                const semaforoPath = 'matrices/SEMÁFORO.csv';
                const res = await fetch(encodeURI(semaforoPath), { cache: 'no-store' });
                if (!res.ok) {
                    console.warn('[SEMAFORO] No se pudo cargar:', semaforoPath, res.status);
                    return;
                }
                const csvText = await res.text();
                const rows = parseCsv(csvText);

                const activityNames = [];
                for (const r of rows) {
                    const first = (r && r.length ? String(r[0] || '') : '').trim();
                    if (!first) continue;
                    const firstCanon = canonicalizeName(first);
                    if (!firstCanon) continue;
                    if (firstCanon === 'ACTIVIDAD') continue;
                    if (firstCanon.startsWith('1 ')) continue; // encabezado de sección
                    activityNames.push(first);
                }

                const semaforoByCanon = new Map();
                for (const name of activityNames) {
                    const key = canonicalizeName(name);
                    if (!key) continue;
                    if (!semaforoByCanon.has(key)) semaforoByCanon.set(key, new Set());
                    semaforoByCanon.get(key).add(name);
                }

                const orgsByCanon = new Map();
                organizations.forEach((org) => {
                    const key = canonicalizeName(org && org.name);
                    if (!key) return;
                    if (!orgsByCanon.has(key)) orgsByCanon.set(key, new Set());
                    orgsByCanon.get(key).add(org.name);
                });

                const semaforoKeys = new Set(semaforoByCanon.keys());
                const orgKeys = new Set(orgsByCanon.keys());

                const onlySemaforo = [...semaforoKeys].filter((k) => !orgKeys.has(k));
                const onlyOrgs = [...orgKeys].filter((k) => !semaforoKeys.has(k));
                const intersection = [...semaforoKeys].filter((k) => orgKeys.has(k));

                const sample = (arr, max = 30) => arr.slice(0, max);
                const expandNames = (keys, sourceMap) =>
                    keys.flatMap((k) => Array.from(sourceMap.get(k) || [])).filter(Boolean);

                console.groupCollapsed(`[SEMAFORO] Comparación lista orgs vs CSV — coinciden: ${intersection.length}, solo SEMÁFORO: ${onlySemaforo.length}, solo orgs: ${onlyOrgs.length}`);
                console.log('[SEMAFORO] Coinciden (muestra):', sample(expandNames(intersection, orgsByCanon), 20));
                console.log('[SEMAFORO] Solo en SEMÁFORO (muestra):', sample(expandNames(onlySemaforo, semaforoByCanon), 30));
                console.log('[SEMAFORO] Solo en orgs (muestra):', sample(expandNames(onlyOrgs, orgsByCanon), 30));
                console.groupEnd();
            } catch (e) {
                console.warn('[SEMAFORO] Error comparando:', e);
            }
        };

        const validateDataOnce = () => {
            const missingContribution = [];
            const missingLatLng = [];
            const missingDepartment = [];

            organizations.forEach((org) => {
                if (typeof org.contribution !== 'number') missingContribution.push(org.name);
                if (typeof org.lat !== 'number' || typeof org.lng !== 'number') missingLatLng.push(org.name);
                if (isColombian(org) && !getDepartment(org) && normalizeKey(org.city) !== 'amazonas') {
                    missingDepartment.push(`${org.city} :: ${org.name}`);
                }
            });

            if (missingContribution.length) console.warn('[DATA] Organizaciones sin contribution numérica:', missingContribution);
            if (missingLatLng.length) console.warn('[DATA] Organizaciones sin lat/lng:', missingLatLng);
            if (missingDepartment.length) console.warn('[DATA] Ciudades sin departamento mapeado:', missingDepartment);
        };

        validateDataOnce();
        reportSemaforoComparison();

        const hydrateBeneficiariosYTerritorio = async () => {
            const cityDeptMap = await buildAgendaCityDepartmentMap();
            const fcoRecords = await loadFcoBeneficiariesMatrix();

            const stopTokens = new Set([
                'FUNDACION','FUNDACIÓN','CORPORACION','CORPORACIÓN','ASOCIACION','ASOCIACIÓN','COLECTIVO','JUNTA','ACCION','ACCIÓN',
                'COMUNAL','COMPAÑIA','COMPAÑÍA','CASA','CULTURAL','CULTURA','SOCIOCULTURAL','SOCIO','SOCIAL',
                'PARA','POR','DEL','DE','LA','EL','LOS','LAS','Y','E','EN','AL','A','UN','UNA','UNOS','UNAS'
            ]);

            const tokenizeOrg = (name) =>
                canonicalizeName(name)
                    .split(' ')
                    .map((t) => t.trim())
                    .filter((t) => t && !stopTokens.has(t));

            const orgCandidates = organizations
                .filter((o) => !isOperationalTeamRecord(o))
                .map((o) => {
                    const canonName = canonicalizeName(o.name);
                    const tokens = new Set(tokenizeOrg(o.name));
                    return { org: o, canonName, tokens };
                });

            const findBestOrgMatch = (queryName) => {
                const qCanon = canonicalizeName(queryName);
                if (!qCanon) return null;
                const qTokens = new Set(tokenizeOrg(queryName));

                let best = null;
                let bestScore = 0;

                for (const cand of orgCandidates) {
                    if (cand.canonName === qCanon) return cand.org;

                    // substring boost for near-equals
                    if (cand.canonName && (cand.canonName.includes(qCanon) || qCanon.includes(cand.canonName))) {
                        if (0.9 > bestScore) {
                            bestScore = 0.9;
                            best = cand.org;
                        }
                        continue;
                    }
                    
                    // Subset check: if the candidate (usually shorter in code) is fully contained in the query (CSV)
                    if (cand.tokens.size > 0 && [...cand.tokens].every(t => qTokens.has(t))) {
                        if (0.95 > bestScore) {
                            bestScore = 0.95;
                            best = cand.org;
                        }
                        continue;
                    }

                    // Jaccard similarity
                    const inter = [...qTokens].filter((t) => cand.tokens.has(t)).length;
                    const union = new Set([...qTokens, ...cand.tokens]).size;
                    if (!union) continue;
                    const score = inter / union;
                    if (score > bestScore) {
                        bestScore = score;
                        best = cand.org;
                    }
                }

                // Threshold tuned for these data (avoid accidental matches)
                if (best && bestScore >= 0.2) return best;
                return null;
            };

            const veredasAll = [];
            const municipiosAll = [];
            const ciudadesAll = [];

            const unmatched = [];
            const matched = [];
            fcoRecords.forEach((rec) => {
                const org = findBestOrgMatch(rec.org);
                if (!org) {
                    unmatched.push(rec.org);
                    return;
                }
                matched.push({ fco: rec.org, org: org.name });

                // Beneficiarios por categoría (según matriz FCO)
                org.beneficiaries = {
                    direct: toInt(rec.direct),
                    indirect: toInt(rec.indirect),
                    public: toInt(rec.public),
                    source: 'FCO'
                };

                // Territorio (veredas/municipios/ciudades)
                const terr = parseTerritoriesFromFco(rec.territoriesRaw);
                terr.veredas.forEach((v) => {
                    const dept = inferDepartmentForPlace(v, rec.departments, cityDeptMap);
                    veredasAll.push(dept ? `${v} — ${dept}` : v);
                });
                terr.municipios.forEach((m) => {
                    const dept = inferDepartmentForPlace(m, rec.departments, cityDeptMap);
                    municipiosAll.push(dept ? `${m} — ${dept}` : m);
                });
                terr.ciudades.forEach((c) => {
                    const dept = inferDepartmentForPlace(c, rec.departments, cityDeptMap);
                    ciudadesAll.push(dept ? `${c} — ${dept}` : c);
                });
            });

            // --- LÓGICA DE DISTRIBUCIÓN DE TOTALES (OVERRIDE) ---
            // Se fuerzan los totales suministrados por el usuario, distribuyéndolos entre las organizaciones de cada red.
            // Para "Organizaciones Emergentes" se aplica un factor de ajuste (+1/3) por subregistro.

            const TARGETS = {
                'Red de mujeres artistas y gestoras REMAG': { direct: 307, indirect: 1423, public: 2565 },
                // 'Red Intercultural Juvenil': { direct: 1268, indirect: 4321, public: 21565 }, // SE USA DATA MANUAL
                // 'Red Hip Hop': { direct: 347, indirect: 1984, public: 6575 }, // SE USA DATA MANUAL
                'Organizaciones Emergentes': { 
                    direct: Math.round(925 * 1.3333), 
                    indirect: Math.round(8533 * 1.3333), 
                    public: Math.round(30065 * 1.3333) 
                }
            };

            // Datos manuales (Fuente: Matriz FCO provista por usuario 21/12/2025)
            const manualDataOverride = {
                // --- RED DE MUJERES (REMAG) ---
                'Asociación Wiwa Abudzibu': { direct: 14, indirect: 53, public: 70 },
                'ORVIEN (Víctimas Río Iró)': { direct: 25, indirect: 300, public: 320 },
                'FUNDACION MICELIO': { direct: 50, indirect: 130, public: 600 },
                'COMPAÑÍA AMÉRICA DANZA': { direct: 15, indirect: 80, public: 150 },
                'FUNDACIÓN PATERPAUTT': { direct: 16, indirect: 45, public: 45 },
                'Asociación de Vecinos Granjas de San Pablo ASOVEG': { direct: 16, indirect: 100, public: 150 },
                'Corporación Errante Lab': { direct: 15, indirect: 25, public: 50 },
                'Asociación de mujeres triunfadoras tejiendo vida': { direct: 5, indirect: 60, public: 70 },
                'Fundación el hogar de tota': { direct: 15, indirect: 100, public: 20 },
                'asociacion de mujeres casa del sembrador': { direct: 70, indirect: 190, public: 190 },
                'FUNDACION CULTURAL KYNZA XIE': { direct: 16, indirect: 240, public: 400 },
                'Corporación violeta en movimiento': { direct: 50, indirect: 100, public: 500 },

                // --- RED INTERCULTURAL JUVENIL ---
                'La Tigra': { direct: 26, indirect: 247, public: 10 },
                'INFLUENCERS ETNICOS': { direct: 7, indirect: 25, public: 84 },
                'PARCHEMOS POR YACOPI': { direct: 24, indirect: 102, public: 250 },
                'Arreglando el País': { direct: 4, indirect: 16, public: 450 },
                'PACIFICA CULTURAL': { direct: 76, indirect: 45, public: 230 },
                'ARTE SHEMBASENG': { direct: 14, indirect: 30, public: 100 }, // Match: La Minga Muralista Kamentsa
                'REY DE LA SELVA': { direct: 30, indirect: 102, public: 200 },
                'CÓDIGO ESTILO CREW': { direct: 27, indirect: 200, public: 1000 },
                'ATICOYA': { direct: 13, indirect: 105, public: 105 }, // Match: Comunicación Visual Sin Fronteras (Amazonas)
                'The Giants Community': { direct: 150, indirect: 600, public: 5000 },
                'ECOSISTEMAS CULTURALES': { direct: 45, indirect: 200, public: 1500 },
                'HUELLAS DE MI TIERRA': { direct: 140, indirect: 121, public: 1 }, // Match: corpohuellas
                'CALINA CUMBAY': { direct: 15, indirect: 155, public: 300 },
                'YUKUTA SONIDO NATIVO': { direct: 35, indirect: 30, public: 420 },
                'NUEVO ESTILO DANCE': { direct: 60, indirect: 300, public: 200 },
                'Corporación Emergiendo': { direct: 25, indirect: 125, public: 2600 },
                'MANGLARIA DIVERSA': { direct: 45, indirect: 51, public: 450 },
                'Jóvenes Creadores Chocó': { direct: 80, indirect: 200, public: 300 },
                'FAHRENHEIT 451': { direct: 23, indirect: 132, public: 918 },
                'AMAHIA': { direct: 32, indirect: 25, public: 60 },
                'RITMO EXTREMO': { direct: 15, indirect: 300, public: 300 },
                'LINDEROS DE PAZ': { direct: 35, indirect: 70, public: 110 },
                'ESCUELA LA ESFERA': { direct: 14, indirect: 42, public: 45 }, // Match: MUSIQULTURA (San Andrés)
                'RED CEPELA': { direct: 34, indirect: 37, public: 80 },
                'Vida-Paz': { direct: 8, indirect: 145, public: 300 },
                'KOMBILESA MI': { direct: 10, indirect: 50, public: 80 },
                'Guaque/Territorialidades': { direct: 46, indirect: 99, public: 26 },
                'Corporación Elements': { direct: 57, indirect: 207, public: 300 },
                'ASOCIACION RESONANCIA': { direct: 47, indirect: 99, public: 562 },
                'ALAS Y RAÍCES': { direct: 18, indirect: 320, public: 500 },
                'KHUYAY': { direct: 46, indirect: 60, public: 295 },
                'D Three Studio': { direct: 25, indirect: 115, public: 230 },

                // --- RED HIP HOP ---
                'HIP HOP IPIALES': { direct: 40, indirect: 100, public: 500 },
                'EXPRESION TEJIDA': { direct: 20, indirect: 57, public: 400 }, // Match: Newspaper
                'CASA KOLACHO': { direct: 15, indirect: 80, public: 550 },
                'EL CIRCULO HIP HOP': { direct: 20, indirect: 85, public: 450 },
                'PAZ Y TERRITORIO': { direct: 42, indirect: 231, public: 500 },
                'SURPRISE CITY': { direct: 50, indirect: 160, public: 1000 },
                'CASA BEAT': { direct: 19, indirect: 228, public: 735 },
                '5TA CON 5TA CREW': { direct: 10, indirect: 100, public: 250 },
                'RAPJUDESCO': { direct: 12, indirect: 45, public: 900 },
                'CASITA DE COLORES': { direct: 8, indirect: 150, public: 250 }, // Match: JAC Agua Bonita 2
                'POR NUESTRA TIERRA': { direct: 28, indirect: 140, public: 250 },
                'HIP HOP POR LA VIDA': { direct: 20, indirect: 150, public: 400 },
                'TURA HIP HOP': { direct: 15, indirect: 85, public: 120 },
                'CASA DEL BARDO': { direct: 20, indirect: 60, public: 120 },
                'MONTAÑA RECORDS': { direct: 28, indirect: 313, public: 150 },
                'HIP HOP PEÑA': { direct: 25, indirect: 51, public: 25 }
            };

            // Aplicar datos manuales
            organizations.forEach(org => {
                if (manualDataOverride[org.name]) {
                    org.beneficiaries = {
                        ...manualDataOverride[org.name],
                        source: 'MANUAL_OVERRIDE'
                    };
                }
            });

            const distributeTotals = () => {
                Object.keys(TARGETS).forEach(networkKey => {
                    const target = TARGETS[networkKey];
                    const orgsInNet = organizations.filter(o => o.network === networkKey && !isOperationalTeamRecord(o));
                    
                    if (orgsInNet.length === 0) return;

                    // 1. Calcular "pesos" actuales (basados en CSV o seed)
                    let sumDirect = 0, sumIndirect = 0, sumPublic = 0;
                    
                    orgsInNet.forEach(org => {
                        // Si tiene datos del CSV, usarlos como peso. Si no, usar 1 como peso base.
                        const hasData = org.beneficiaries && org.beneficiaries.source === 'FCO';
                        
                        // Pesos temporales
                        org._wDirect = hasData ? (org.beneficiaries.direct || 1) : 1;
                        org._wIndirect = hasData ? (org.beneficiaries.indirect || 1) : 1;
                        org._wPublic = hasData ? (org.beneficiaries.public || 1) : 1;

                        sumDirect += org._wDirect;
                        sumIndirect += org._wIndirect;
                        sumPublic += org._wPublic;
                    });

                    // 2. Distribuir el target proporcionalmente
                    let accDirect = 0, accIndirect = 0, accPublic = 0;

                    orgsInNet.forEach((org, i) => {
                        const isLast = i === orgsInNet.length - 1;

                        // Directos
                        let valDirect;
                        if (isLast) valDirect = target.direct - accDirect;
                        else valDirect = Math.round((org._wDirect / sumDirect) * target.direct);
                        accDirect += valDirect;

                        // Indirectos
                        let valIndirect;
                        if (isLast) valIndirect = target.indirect - accIndirect;
                        else valIndirect = Math.round((org._wIndirect / sumIndirect) * target.indirect);
                        accIndirect += valIndirect;

                        // Públicos
                        let valPublic;
                        if (isLast) valPublic = target.public - accPublic;
                        else valPublic = Math.round((org._wPublic / sumPublic) * target.public);
                        accPublic += valPublic;

                        // Asignar valores finales
                        org.beneficiaries = {
                            direct: valDirect,
                            indirect: valIndirect,
                            public: valPublic,
                            source: 'DISTRIBUTED'
                        };
                    });
                });
            };

            distributeTotals();
            // -------------------------------------------------------

            if (unmatched.length) {
                console.warn('[BENEFICIARIOS] Organizaciones en FCO sin match en el dashboard (muestra):', unmatched.slice(0, 25));
            }

            if (matched.length) {
                console.log('[BENEFICIARIOS] Matches FCO->dashboard (muestra):', matched.slice(0, 20));
            }

            // Actualiza cobertura territorial con base en FCO + fallback (regionalización)
            territorialCoverage.veredas = uniqSorted(veredasAll);
            territorialCoverage.municipios = uniqSorted([...municipiosAll, ...regionalizationImpactLists.municipalitiesAndCities]);
            territorialCoverage.ciudades = uniqSorted(ciudadesAll);
            territorialCoverage.municipalitiesAndCitiesCount =
                new Set([...territorialCoverage.veredas, ...territorialCoverage.municipios, ...territorialCoverage.ciudades]).size;

            // Verificación total beneficiarios
            const totals = { direct: 0, indirect: 0, public: 0, total: 0 };
            organizations.forEach((org) => {
                if (isOperationalTeamRecord(org)) return;

                let direct = 0;
                let indirect = 0;
                let pub = 0;

                if (org.beneficiaries) {
                    direct = toInt(org.beneficiaries.direct);
                    indirect = toInt(org.beneficiaries.indirect);
                    pub = toInt(org.beneficiaries.public);
                } 
                // NOTA: Se elimina el fallback a org.events para evitar doble conteo o datos no normalizados,
                // ya que ahora se fuerza la distribución de totales (distributeTotals).
                
                totals.direct += direct;
                totals.indirect += indirect;
                totals.public += pub;
            });
            totals.total = totals.direct + totals.indirect + totals.public;

            console.log('[BENEFICIARIOS] Totales finales:', totals);
        };

        // 2. CONFIGURACIÓN LEAFLET
        const map = L.map('map', { 
            zoomControl: false,
            scrollWheelZoom: false,
            dragging: !L.Browser.mobile,
            tap: !L.Browser.mobile
        }).setView([4.5709, -74.2973], 6);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        const shouldEnableWheelZoom = () => hasFinePointer() && isWideLayout() && isLandscapeLayout();
        const syncMapWheelZoom = () => {
            if (shouldEnableWheelZoom()) map.scrollWheelZoom.enable();
            else map.scrollWheelZoom.disable();
        };
        syncMapWheelZoom();
        window.addEventListener('resize', syncMapWheelZoom);

        // Capa Estilo "Claro"
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO'
        }).addTo(map);

        // 3. CLUSTERS Y MARCADORES
        const markers = L.markerClusterGroup({
            maxClusterRadius: 30, // Reduce el radio de agrupación para mostrar más puntos individuales
            showCoverageOnHover: false,
            spiderfyDistanceMultiplier: 2,
            iconCreateFunction: function(cluster) {
                const children = cluster.getAllChildMarkers();
                let dominant = children[0].options.network;
                let cClass = '';
                const dom = (dominant || '').toLowerCase();
                if(dom.includes('hip hop')) cClass = 'marker-cluster-hiphop';
                else if(dom.includes('emergentes')) cClass = 'marker-cluster-emergentes';
                else if(dom.includes('juvenil')) cClass = 'marker-cluster-juvenil';
                else if(dom.includes('mujer')) cClass = 'marker-cluster-mujeres';
                else if(dom.includes('circulaci')) cClass = 'marker-cluster-circulacion';
                
                return new L.DivIcon({ 
                    html: `<div>${cluster.getChildCount()}</div>`, 
                    className: `marker-cluster ${cClass}`, 
                    iconSize: L.point(40, 40) 
                });
            }
        });

        // Iconos de Imagen
        const getIcon = (network) => {
            let iconUrl = '../assets/img/Iconos_Amarillo/CCDP_Icono_Cometa_Sin_Marco.png'; // Default / Circulación
            let size = [48, 48]; // Doble tamaño para CDP

            const net = (network || '').toLowerCase();
            if(net.includes('hip hop')) { iconUrl = '../assets/img/REDDEHIPHOP.png'; size = [24, 24]; }
            else if(net.includes('emergentes')) { iconUrl = '../assets/img/ORGANIZACIONES%20EMERGENTES.png'; size = [24, 24]; }
            else if(net.includes('juvenil')) { iconUrl = '../assets/img/RED%20JUVENIL.png'; size = [24, 24]; }
            else if(net.includes('mujer')) { iconUrl = '../assets/img/ORGANIZACIONES%20DE%20MUJERES.png'; size = [24, 24]; }
            else if(net.includes('festiva')) { iconUrl = '../assets/img/Iconos_Amarillo/CCDP_Icono_Sol_Sin_Marco.png'; }
            else if(net.includes('narrativas')) { iconUrl = '../assets/img/Iconos_Amarillo/CCDP_Icono_Arbol_Sin_Marco.png'; }
            
            return L.icon({
                iconUrl: iconUrl,
                iconSize: size,
                iconAnchor: [size[0]/2, size[1]/2],
                popupAnchor: [0, -size[1]/2],
                className: 'custom-pin-img drop-shadow-md hover:scale-110 transition-transform'
            });
        };

        // 4. RENDERIZADO
        let chartInvestment = null;
        let chartRegion = null;

        const isOperationalTeamRecord = (org) => {
            const name = (org && org.name ? String(org.name) : '').toLowerCase();
            return (
                name.includes('cesar augusto rubio') ||
                name.includes('john freddy') ||
                name.includes('donatello') ||
                name.includes('felipe camacho') ||
                name.includes('angie mora') ||
                name.includes('mercy tatiana arias') ||
                name.includes('jeimy') ||
                name.includes('jeimmy') ||
                name.includes('jaime')
            );
        };

        const getCountsForOrg = (org) => {
            if (org && org.beneficiaries) {
                return {
                    direct: toInt(org.beneficiaries.direct),
                    indirect: toInt(org.beneficiaries.indirect),
                    public: toInt(org.beneficiaries.public)
                };
            }

            // Fallback: deriva indirectos/publico de los eventos embebidos (Agenda) cuando no hay registro en FCO.
            let direct = 0;
            let indirect = 0;
            let pub = 0;
            if (org && org.events) {
                org.events.forEach((ev) => {
                    const t = (ev.type || '').toString().toUpperCase();
                    const ben = toInt(ev.ben);
                    if (!ben) return;
                    if (t.includes('FORMACIÓN') || t.includes('FORMACION')) indirect += ben;
                    else if (t.includes('PÚBLICO') || t.includes('PUBLICO')) pub += ben;
                    else pub += ben; // circulación/socialización a público
                });
            }
            return { direct, indirect, public: pub };
        };

        function renderMarkers(filterText = '', activeTypes = ['formacion','circulacion','publico'], activeNetworks = []) {
            markers.clearLayers();
            let totalBen = 0;
            let totalBenDirect = 0;
            let totalBenIndirect = 0;
            let totalBenPublic = 0;
            let totalContribution = 0;
            let filteredOrgs = [];

            organizations.forEach(org => {
                // Excluir rubros del equipo (personas) del mapa y de la suma de inversión por organizaciones
                if (isOperationalTeamRecord(org)) return;

                // Filtro Texto
                const matchText = filterText === '' || 
                                  org.name.toLowerCase().includes(filterText.toLowerCase()) || 
                                  org.city.toLowerCase().includes(filterText.toLowerCase());

                // Filtro Red
                const matchNetwork = activeNetworks.length === 0 || activeNetworks.includes(org.network);

                // Filtro Tipo (Al menos un evento coincide)
                let matchType = false;
                if(org.events) {
                    org.events.forEach(ev => {
                        const typeKey = ev.type.toUpperCase().includes('FORMACIÓN') || ev.type.toUpperCase().includes('FORMACION') ? 'formacion' :
                                        ev.type.toUpperCase().includes('PÚBLICO') || ev.type.toUpperCase().includes('PUBLICO') ? 'publico' : 'circulacion';
                        if(activeTypes.includes(typeKey)) matchType = true;
                    });
                } else {
                    matchType = true;
                }

                if (matchText && matchType && matchNetwork) {
                    filteredOrgs.push(org);

                    // Sumas beneficiarios por categoría
                    const counts = getCountsForOrg(org);
                    const hasAnyType = Array.isArray(activeTypes) && activeTypes.length > 0;
                    const wantsIndirect = activeTypes.includes('formacion');
                    const wantsPublic = activeTypes.includes('publico') || activeTypes.includes('circulacion');

                    if (hasAnyType) {
                        totalBenDirect += counts.direct;
                        if (wantsIndirect) totalBenIndirect += counts.indirect;
                        if (wantsPublic) totalBenPublic += counts.public;
                        totalBen += counts.direct + (wantsIndirect ? counts.indirect : 0) + (wantsPublic ? counts.public : 0);
                    }

                    if(org.contribution) totalContribution += org.contribution;

                    const m = L.marker([org.lat, org.lng], { icon: getIcon(org.network), network: org.network });
                    
                    // Popup
                    const totalOrgBen = counts.direct + counts.indirect + counts.public;
                    let popupContent = `<div class="p-2 font-montserrat min-w-[220px]">
                        <h4 class="font-bold text-palette-dark border-b pb-1 mb-2 leading-tight">${org.name}</h4>
                        <div class="flex justify-between items-center text-xs mb-2 text-gray-500">
                            <span><i class="fas fa-city"></i> ${org.city}</span>
                            <span class="bg-gray-100 px-2 py-0.5 rounded text-[10px]">${org.network.split(' ')[0]}...</span>
                        </div>

                        <div class="grid grid-cols-2 gap-x-2 gap-y-1 mb-3 bg-gray-50 p-2 rounded border border-gray-100 text-[10px]">
                            <div><span class="text-gray-400">Directos:</span> <span class="font-bold block text-gray-700">${counts.direct.toLocaleString()}</span></div>
                            <div><span class="text-gray-400">Indirectos:</span> <span class="font-bold block text-gray-700">${counts.indirect.toLocaleString()}</span></div>
                            <div class="col-span-2"><span class="text-gray-400">Público:</span> <span class="font-bold ml-1 text-gray-700">${counts.public.toLocaleString()}</span></div>
                            <div class="col-span-2 border-t border-gray-200 pt-1 mt-1 flex justify-between items-center">
                                <span class="text-gray-500 font-bold uppercase text-[9px]">Total Beneficiarios</span> 
                                <span class="font-black text-palette-purple text-xs">${totalOrgBen.toLocaleString()}</span>
                            </div>
                        </div>

                        <div class="space-y-1 max-h-32 overflow-y-auto">`;
                    
                    if(org.events) {
                        org.events.forEach(ev => {
                             popupContent += `<div class="bg-white p-1.5 rounded text-xs border border-gray-100 shadow-sm">
                                <strong class="block leading-tight mb-0.5">${ev.name}</strong>
                                <span class="text-[9px] text-gray-400 uppercase tracking-wider">${ev.type}</span>
                             </div>`;
                        });
                    }
                    
                    popupContent += `</div></div>`;
                    m.bindPopup(popupContent);
                    markers.addLayer(m);
                }
            });
            
            map.addLayer(markers);
            document.getElementById('total-ben-count').innerText = totalBen.toLocaleString();
            document.getElementById('total-dept-count').innerText = totalBenDirect.toLocaleString('es-CO');
            document.getElementById('total-operational-count').innerText = totalBenIndirect.toLocaleString('es-CO');
            document.getElementById('total-operational-costs-count').innerText = totalBenPublic.toLocaleString('es-CO');
            document.getElementById('total-contribution-count').innerText = formatCop(totalAgreementInvestment, 2);

            // Calcular territorios dinámicamente basado en organizaciones filtradas
            const filteredDepartments = new Set();
            const filteredMunicipalities = new Set();
            
            filteredOrgs.forEach(org => {
                const dept = getDepartment(org);
                if (dept && dept !== 'Internacional') {
                    filteredDepartments.add(dept);
                }
                const muni = getMunicipalityName(org);
                if (muni) {
                    filteredMunicipalities.add(muni);
                }
            });

            // Actualizar contadores de territorios
            // Siempre mostrar 30 departamentos y 112 municipios (datos oficiales del programa)
            const deptCount = regionalizationImpactLists.departments.length; // Siempre 30
            const muniCount = regionalizationImpactLists.municipalitiesAndCities.length; // Siempre 112
            
            document.getElementById('total-dept-display').innerText = deptCount.toLocaleString('es-CO');
            document.getElementById('total-muni-count').innerText = muniCount.toLocaleString('es-CO');
            
            updateCharts(filteredOrgs, totalBen, totalContribution);
        }

        // 5. DASHBOARD & CHARTS
        window.toggleDashboard = () => {
            const modal = document.getElementById('dashboard-modal');
            if(modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                setTimeout(() => {
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    modal.querySelector('div').classList.remove('scale-95');
                    modal.querySelector('div').classList.add('scale-100');
                    // Siempre re-crear el gráfico cuando el modal sea visible
                    const filtered = organizations.filter(o => !isOperationalTeamRecord(o));
                    const totalBen = filtered.reduce((acc, o) => acc + (o.beneficiaries || 0), 0);
                    const totalContribution = filtered.reduce((acc, o) => acc + (o.contribution || 0), 0);
                    updateCharts(filtered, totalBen, totalContribution);
                }, 100);
            } else {
                modal.classList.add('opacity-0', 'pointer-events-none');
                modal.querySelector('div').classList.remove('scale-100');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                }, 300);
            }
        };

        function updateCharts(data, totalBen, totalContribution) {
            try {
            // Stats Cards - valor fijo de 105 organizaciones de base fortalecidas
            const statOrgsEl = document.getElementById('stat-orgs');
            if (statOrgsEl) statOrgsEl.innerText = '105';
            
            // Calcular territorios dinámicamente para el dashboard
            const dashDepts = new Set();
            const dashMunis = new Set();
            data.forEach(org => {
                const dept = getDepartment(org);
                if (dept && dept !== 'Internacional') dashDepts.add(dept);
                const muni = getMunicipalityName(org);
                if (muni) dashMunis.add(muni);
            });
            const statCitiesEl = document.getElementById('stat-cities');
            if (statCitiesEl) statCitiesEl.innerText = dashMunis.size;
            
            const totalEvents = data.reduce((acc, curr) => acc + (curr.events ? curr.events.length : 0), 0);
            const statEventsEl = document.getElementById('stat-events');
            if (statEventsEl) statEventsEl.innerText = totalEvents;
            // Valor fijo del convenio (no por organización) - formato compacto sin decimales
            const statAvgEl = document.getElementById('stat-avg');
            if (statAvgEl) statAvgEl.innerText = formatCop(totalAgreementInvestment, 0);

            // Chart 1: Investment by Network
            const netData = {};
            data.forEach(o => {
                if(!netData[o.network]) netData[o.network] = 0;
                if(o.contribution) netData[o.network] += o.contribution;
            });

            const canvasEl = document.getElementById('chart-investment');
            if (!canvasEl) return;
            const ctxInv = canvasEl.getContext('2d');
            if(chartInvestment) chartInvestment.destroy();
            
            chartInvestment = new Chart(ctxInv, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(netData),
                    datasets: [{
                        data: Object.values(netData),
                        backgroundColor: ['#E940B4', '#F3C746', '#0066FF', '#886FFF', '#5BC6FB', '#1A1A3A', '#2DD4BF', '#F97316'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        const dataset = context.dataset && Array.isArray(context.dataset.data) ? context.dataset.data : [];
                                        const total = dataset.reduce((acc, n) => acc + (Number(n) || 0), 0);
                                        const value = Number(context.parsed) || 0;
                                        const pct = total ? (value / total) * 100 : 0;
                                        label += new Intl.NumberFormat('es-CO', { maximumFractionDigits: 1 }).format(pct) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            } catch (err) {
                console.error('Error en updateCharts:', err);
            }
        }

        // 6. INICIALIZACIÓN Y EVENTOS
        // Toggle Filters Mobile
        const filterToggle = document.getElementById('filter-toggle');
        const mapControls = document.getElementById('map-controls');
        
        filterToggle.addEventListener('click', () => {
            mapControls.classList.toggle('hidden');
        });

        window.toggleFilters = () => {
            mapControls.classList.add('hidden');
        };

        window.toggleFullScreen = () => {
            const elem = document.getElementById('map-wrapper');
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
                // Show toast or alert about ESC
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded-full text-sm z-[2000] transition-opacity duration-500 pointer-events-none';
                toast.innerText = 'Presiona ESC para salir de pantalla completa';
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            } else {
                document.exitFullscreen();
            }
        };

        const escapeHtml = (value) => {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        };

        let impactListsRendered = false;

        const renderImpactListsOnce = () => {
            if (impactListsRendered) return;

            const combinedUl = document.getElementById('impact-combined-list');
            const deptUl = document.getElementById('impact-dept-list');
            
            // Renderizar departamentos
            if (deptUl && regionalizationImpactLists.departments.length) {
                deptUl.innerHTML = regionalizationImpactLists.departments
                    .map((item) => `<li class="text-gray-700 text-xs py-0.5">${escapeHtml(item)}</li>`)
                    .join('');
            }
            
            // Combine all lists for municipalities
            const allItems = [
                ...territorialCoverage.veredas, 
                ...territorialCoverage.municipios, 
                ...territorialCoverage.ciudades
            ];
            const uniqueItems = uniqSorted(allItems);

            if (!combinedUl) return;
            if (!uniqueItems.length) {
                combinedUl.innerHTML = `<li class="text-gray-500 italic">Sin registros.</li>`;
                return;
            }
            combinedUl.innerHTML = uniqueItems
                .map((item) => `<li class="text-gray-700 border-b border-gray-100 last:border-0 py-1">${escapeHtml(item)}</li>`)
                .join('');

            impactListsRendered = true;
        };

        window.closeImpactLists = () => {
            document.getElementById('impact-lists')?.classList.add('hidden');
            document.getElementById('impact-muni-panel')?.classList.add('hidden');

            const container = document.getElementById('impact-lists');
            if (container) container.onclick = null;
        };

        const shouldCloseImpactListsOnContainerClick = () => hasFinePointer() && isWideLayout() && isLandscapeLayout();
        const syncImpactListCloseBehavior = () => {
            const container = document.getElementById('impact-lists');
            if (!container) return;
            if (container.classList.contains('hidden')) {
                container.onclick = null;
                return;
            }

            // En pantallas horizontales (desktop), se puede cerrar haciendo clic en el \u00e1rea del listado.
            // En m\u00f3vil/vertical, se evita ese comportamiento para poder recorrer el listado sin cierres accidentales.
            if (shouldCloseImpactListsOnContainerClick()) {
                container.onclick = () => window.closeImpactLists && window.closeImpactLists();
            } else {
                container.onclick = null;
            }
        };

        window.toggleImpactList = (kind) => {
            renderImpactListsOnce();

            const container = document.getElementById('impact-lists');
            const muniPanel = document.getElementById('impact-muni-panel');
            if (!container || !muniPanel) return;

            container.classList.remove('hidden');
            muniPanel.classList.remove('hidden');

            syncImpactListCloseBehavior();
        };

        window.addEventListener('resize', () => {
            syncImpactListCloseBehavior();
        });

        const boot = async () => {
            await hydrateBeneficiariosYTerritorio();

            // Update total processes count in header - valor fijo de 150 procesos fortalecidos
            const totalProcessesEl = document.getElementById('total-processes-count');
            if (totalProcessesEl) totalProcessesEl.innerText = '150';

            // Generar Filtros de Red
            // Excluir redes que no deben mostrarse como filtros
            const excludedNetworks = ['Circulación Nacional e Internacional', 'Cultura Festiva del Territorio', 'Narrativas Artísticas y Bioculturales'];
            const nets = [...new Set(organizations.map(o => o.network))].filter(n => !excludedNetworks.includes(n));
            const filtersList = document.getElementById('filters-list');
            if (filtersList) filtersList.innerHTML = '';
            
            nets.forEach(n => {
            let iconUrl = '../assets/img/Iconos_Amarillo/CCDP_Icono_Cometa_Sin_Marco.png';
            let iconClass = 'w-6 h-6'; // Default size

            const nn = (n || '').toLowerCase();
            if(nn.includes('hip hop')) { iconUrl = '../assets/img/REDDEHIPHOP.png'; iconClass = 'w-3 h-3'; }
            else if(nn.includes('emergentes')) { iconUrl = '../assets/img/ORGANIZACIONES%20EMERGENTES.png'; iconClass = 'w-3 h-3'; }
            else if(nn.includes('juvenil')) { iconUrl = '../assets/img/RED%20JUVENIL.png'; iconClass = 'w-3 h-3'; }
            else if(nn.includes('mujer')) { iconUrl = '../assets/img/ORGANIZACIONES%20DE%20MUJERES.png'; iconClass = 'w-3 h-3'; }
            else if(nn.includes('festiva')) { iconUrl = '../assets/img/Iconos_Amarillo/CCDP_Icono_Sol_Sin_Marco.png'; }
            else if(nn.includes('narrativas')) { iconUrl = '../assets/img/Iconos_Amarillo/CCDP_Icono_Arbol_Sin_Marco.png'; }
            
            const baseCount = organizations.filter(o => o.network === n).length;
            const overrideCount = beneficiariesNetworkCountOverrides[n];
            const count = Number.isFinite(overrideCount) ? overrideCount : baseCount;

            // Calculate total beneficiaries for this network
            const orgsInNet = organizations.filter(o => o.network === n && !isOperationalTeamRecord(o));
            let netTotalBen = 0;
            orgsInNet.forEach(o => {
                const c = getCountsForOrg(o);
                netTotalBen += (c.direct + c.indirect + c.public);
            });

            const div = document.createElement('div');
            div.className = 'flex flex-col w-full hover:bg-gray-50 p-1 rounded cursor-pointer border-b border-gray-100 last:border-0';
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    <input type="checkbox" class="network-check accent-palette-purple" value="${n}" checked>
                    <div class="w-6 flex justify-center"><img src="${iconUrl}" class="${iconClass} object-contain"></div>
                    <span class="opacity-80 truncate text-[10px] flex-1 font-bold" title="${n}">${n}</span>
                    <span class="text-[9px] font-bold opacity-60">(${count})</span>
                </div>
                <div class="pl-8 text-[9px] text-gray-500 font-medium mt-0.5">
                    Beneficiarios: <span class="text-palette-dark font-bold">${netTotalBen.toLocaleString('es-CO')}</span>
                </div>
            `;
            filtersList.appendChild(div);
            });

            // Listeners
            const activityChecks = document.querySelectorAll('.activity-check');
            const networkChecks = document.querySelectorAll('.network-check'); // Now they exist

            const updateAll = () => {
                const activeTypes = Array.from(activityChecks).filter(ch => ch.checked).map(ch => ch.value);
                const activeNetworks = Array.from(networkChecks).filter(ch => ch.checked).map(ch => ch.value);
                const searchVal = document.getElementById('search-input').value;
                renderMarkers(searchVal, activeTypes, activeNetworks);
            };

            activityChecks.forEach(c => c.addEventListener('change', updateAll));
            document.querySelectorAll('.network-check').forEach(c => c.addEventListener('change', updateAll));

            const searchInput = document.getElementById('search-input');
            const searchClear = document.getElementById('search-clear');
            const suggestions = document.getElementById('search-suggestions');

            searchInput.addEventListener('input', (e) => {
                const val = e.target.value;
                if(val.length > 0) searchClear.classList.remove('hidden');
                else searchClear.classList.add('hidden');

                if(val.length > 2) {
                    const matches = organizations.filter(o => o.name.toLowerCase().includes(val.toLowerCase()));
                    suggestions.innerHTML = matches.slice(0,5).map(m => 
                        `<div class="p-2 hover:bg-gray-100 cursor-pointer border-b text-xs text-left" onclick="zoomTo('${m.name}')">${m.name}</div>`
                    ).join('');
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }
                updateAll();
            });

            searchClear.addEventListener('click', () => {
                searchInput.value = '';
                searchClear.classList.add('hidden');
                suggestions.classList.add('hidden');
                map.setView([4.5709, -74.2973], 6); // Reset view
                updateAll();
            });

            window.zoomTo = (name) => {
                // Normalize for comparison
                const normalize = (str) => str ? str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim() : "";
                const target = normalize(name);

                let org = organizations.find(o => o.name === name); // Try exact match first
                
                if (!org) {
                    // Try fuzzy match
                    org = organizations.find(o => {
                        const n = normalize(o.name);
                        return n === target || n.includes(target) || target.includes(n);
                    });
                }

                if(org) {
                    map.setView([org.lat, org.lng], 12);
                    document.getElementById('search-input').value = org.name;
                    document.getElementById('search-clear').classList.remove('hidden');
                    document.getElementById('search-suggestions').classList.add('hidden');
                    updateAll();
                } else {
                    console.warn('Organization not found for zoom:', name);
                }
            };

            // Initial Render
            renderMarkers('', ['formacion','circulacion','publico'], nets);
        };

        boot();

    });
    </script>
</body>
</html>
